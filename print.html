<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ChiselAIA</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">ChiselAIA</li><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> üò∫AIA</a></li><li class="chapter-item expanded "><a href="imsic.html"><strong aria-hidden="true">2.</strong> üì©IMSIC</a></li><li class="chapter-item expanded "><a href="aplic.html"><strong aria-hidden="true">3.</strong> üß∂APLIC</a></li><li class="chapter-item expanded "><a href="integration.html"><strong aria-hidden="true">4.</strong> üß≠ÈõÜÊàêÊåáÂçóÔºàIntegration GuideÔºâ</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ChiselAIA</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/OpenXiangShan-Nanhu/ChiselAIA" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="chiselaia"><a class="header" href="#chiselaia">üò∫ChiselAIA</a></h1>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="index.html#%E7%AE%80%E4%BB%8Bintroduction">ÁÆÄ‰ªãÔºàIntroductionÔºâ</a></li>
<li><a href="index.html#%E4%B8%AD%E6%96%AD%E9%80%9A%E8%B7%AFinterrupt-paths">‰∏≠Êñ≠ÈÄöË∑ØÔºàInterrupt PathsÔºâ</a></li>
<li><a href="index.html#%E9%85%8D%E7%BD%AE%E9%80%9A%E8%B7%AFconfiguration-paths">ÈÖçÁΩÆÈÄöË∑ØÔºàConfiguration PathsÔºâ</a></li>
<li><a href="index.html#%E5%BC%95%E7%94%A8references">ÂºïÁî®ÔºàReferencesÔºâ</a></li>
</ul>
<!-- vim-markdown-toc -->
<p>ChiselAIAÁöÑÂÆûÁé∞ÈÅµÂæ™<a href="https://github.com/riscv/riscv-aia">RISC-VÈ´òÁ∫ß‰∏≠Êñ≠Êû∂ÊûÑÔºàAdvanced Interrupt Architecture, AIAÔºâËßÑËåÉ</a>„ÄÇ
ÂÆûÁé∞‰∏éËßÑËåÉ‰πãÈó¥ÁöÑ‰ªª‰ΩïÂ∑ÆÂºÇÈÉΩÂ∫îËßÜ‰∏∫ÂÆûÁé∞bug„ÄÇ</p>
<p>The implementation of ChiselAIA adheres to the <a href="https://github.com/riscv/riscv-aia">RISC-V Advanced Interrupt Architecture (AIA) Specification</a>.
Any discrepancies between the implementation and specification should be treated as implementation bugs.</p>
<h2 id="ÁÆÄ‰ªãintroduction"><a class="header" href="#ÁÆÄ‰ªãintroduction">ÁÆÄ‰ªãÔºàIntroductionÔºâ</a></h2>
<p>AIAÊó®Âú®È´òÊïàÂú∞Â∞ÜÂ§ñÈÉ®‰∏≠Êñ≠Ë∑ØÁî±Âà∞ÂØπÂ∫îÁöÑÂ§ÑÁêÜÂô®Ê†∏ÂøÉÔºàhartÔºâÂíåÁâπÊùÉÊÄÅ„ÄÇ
ËøôÁßçË∑ØÁî±ÈÄöËøá‰∏§‰∏™‰∏≠Êñ≠ÊéßÂà∂Âô®Êù•ÂÆåÊàêÔºö</p>
<p>AIA is designed to efficiently route external interrupts to the appropriate harts and privilege levels.
This routing is accomplished by two interrupt controllers:</p>
<ul>
<li>Incoming Message-Signaled Interrupt Controller (<strong>IMSIC</strong>)</li>
<li>Advanced Platform-Level Interrupt Controller (<strong>APLIC</strong>)</li>
</ul>
<p>‰∏∫‰ªÄ‰πàÈúÄË¶Å‰∏§ÁßçÊéßÂà∂Âô®Ôºü
Âõ†‰∏∫Â≠òÂú®‰∏§Á±ªÂ§ñÈÉ®ËÆæÂ§áÔºö</p>
<ol>
<li><strong>Á∫øËÆæÂ§á</strong>Ôºö
ÈÄöËøá‰∏ìÁî®ÁöÑÁîµ‰ø°Âè∑ÔºàËæπÊ≤øÊàñÁîµÂπ≥Ôºâ‰º†Ëæì‰∏≠Êñ≠„ÄÇ
ÂÆÉÁöÑÁâπÁÇπÊòØÂÆûÁé∞ÁÆÄÂçïÔºåÂèØÊâ©Â±ïÊÄßÂ∑Æ„ÄÇ
Âõ†‰∏∫ÊØè‰∏™‰∏≠Êñ≠ÈÉΩÊÑèÂë≥ÁùÄ‰∏ÄÊ†πËøûÊé•Âà∞Â§ÑÁêÜÂô®Ê†∏ÂøÉÁöÑÁâ©ÁêÜÁ∫ø„ÄÇ</li>
<li><strong>Ê∂àÊÅØ‰ø°Âè∑‰∏≠Êñ≠(Message-signaled-interrupt, MSI)ËÆæÂ§á</strong>Ôºö
‰∏≠Êñ≠Ë¢´ÁºñÁ†Å‰∏∫Ê∂àÊÅØÔºåÂπ∂ÈÄöËøáÊÄªÁ∫ø/ÁΩëÁªú‰º†Ëæì„ÄÇ
Âõ†‰∏∫ÊØè‰∏™‰∏≠Êñ≠‰∏çÈúÄË¶Å‰∏ìÁî®ÁöÑÁâ©ÁêÜËøûÁ∫øÔºåÂõ†Ê≠§MSI‰∏éÁ∫ø‰∏≠Êñ≠Áõ∏ÊØîÔºåÊúâÊõ¥Â•ΩÁöÑÂèØÊâ©Â±ïÊÄß„ÄÇ</li>
</ol>
<p>Why two types of controllers?
There are two types of external devices:</p>
<ol>
<li><strong>Wired devices</strong>:
Interrupts are transmitted via dedicated electronic signals (edge or level),
which is simple to implement but faces scalability challenges,
as each interrupt requires an physical wire connected to the hart.</li>
<li><strong>Message-signaled-interrupt (MSI) devices</strong>:
Interrupts are encoded as messages and transmitted over bus/network,
which offers better scalability compared to wired interrupts,
as no dedicated physical wires needed for each interrupt.</li>
</ol>
<p>Âú® RISC-V AIA ‰∏≠Ôºö</p>
<ul>
<li><strong>APLIC</strong>Ë¥üË¥£Â§ÑÁêÜÁ∫øÂ§ñÈÉ®‰∏≠Êñ≠„ÄÇ
<strong>Ê≥®ÊÑè</strong>ÔºöAPLICÂèØ‰ª•Âú®‰∏§ÁßçÊ®°Âºè‰∏ãËøêË°å(domaincfg.DM)Ôºö
<ul>
<li><strong>Áõ¥Êé•ÈÄíÈÄÅÊ®°Âºè</strong>ÔºöAPLICÁõ¥Êé•Â∞ÜÁ∫ø‰∏≠Êñ≠Ë∑ØÁî±Âà∞Â§ÑÁêÜÂô®Ê†∏ÂøÉÔºåÊó†ÈúÄIMSICÂèÇ‰∏é„ÄÇ</li>
<li>MSIÈÄíÈÄÅÊ®°ÂºèÔºöAPLICÂ∞ÜÁ∫ø‰∏≠Êñ≠ËΩ¨Êç¢‰∏∫MSIÂπ∂ËΩ¨ÂèëÁªôIMSIC„ÄÇ</li>
<li>Áî±‰∫éMSIÊõ¥ÂÖ∑Êâ©Â±ïÊÄßÔºåÂêéÁª≠ËÆ®ËÆ∫ÈªòËÆ§APLICÈááÁî®MSIÈÄíÈÄÅÊ®°Âºè„ÄÇ</li>
</ul>
</li>
<li><strong>IMSIC</strong>Ë¥üË¥£Â§ÑÁêÜMSI„ÄÇ</li>
</ul>
<p>In RISC-V AIA:</p>
<ul>
<li><strong>APLIC</strong> handles wired external interrupts.
<strong>Note</strong>: APLIC can operate in two modes (<code>domaincfg.DM</code>):
<ul>
<li><strong>Direct delivery mode</strong>: APLIC directly routes wired interrupts to harts without IMSIC involvement.</li>
<li><strong>MSI delivery mode</strong>: APLIC converts wired interrupts into MSIs and forwards them to IMSIC.</li>
<li>Since MSIs represent the more scalable approach, our subsequent discussion assumes the APLIC working in MSI delivery mode.</li>
</ul>
</li>
<li><strong>IMSIC</strong> handles MSIs.</li>
</ul>
<p>ËÆæÂ§á„ÄÅ‰∏≠Êñ≠ÊéßÂà∂Âô®ÂíåÂ§ÑÁêÜÂô®Ê†∏ÂøÉ‰πãÈó¥ÁöÑ‰∫§‰∫í‰∏ªË¶ÅÊ∂âÂèä‰∏§ÁßçÊï∞ÊçÆÈÄöË∑ØÔºö
<strong>‰∏≠Êñ≠ÈÄöË∑Ø</strong>Âíå<strong>ÈÖçÁΩÆÈÄöË∑Ø</strong>ÔºåÂ¶Ç‰∏ãÈù¢‰∏§Âº†ÂõæÊâÄÁ§∫„ÄÇ</p>
<p>The interaction between devices, interrupt controllers, and harts involves two main types of data paths:
<strong>interrupt paths</strong> and <strong>configuration paths</strong>, shown as the following two figures.</p>
<h2 id="‰∏≠Êñ≠ÈÄöË∑Øinterrupt-paths"><a class="header" href="#‰∏≠Êñ≠ÈÄöË∑Øinterrupt-paths">‰∏≠Êñ≠ÈÄöË∑ØÔºàInterrupt PathsÔºâ</a></h2>
<p>Â§ñÈÉ®‰∏≠Êñ≠‰∏ªË¶ÅÊ∫êËá™Â§ñÈÉ®ËÆæÂ§áÔºå
Â∞ΩÁÆ°Âú®È´òÁ∫ß‰ΩøÁî®Âú∫ÊôØ‰∏≠ÔºåÂÜÖÈÉ®ËÆæÂ§áÂíåÂ§ÑÁêÜÂô®Ê†∏ÂøÉ‰πüÂèØ‰ª•ÁîüÊàê‚ÄúÂ§ñÈÉ®‚Äù‰∏≠Êñ≠
Ôºà‰æãÂ¶ÇÂΩìÁõëÁÆ°ÊÄÅÂêëËôöÊãüÂåñÁõëÁÆ°ÊÄÅÊ≥®ÂÖ•Â§ñÈÉ®‰∏≠Êñ≠Êó∂Ôºâ„ÄÇ
Êé•‰∏ãÊù•ÁöÑËÆ®ËÆ∫ÈáçÁÇπÂÖ≥Ê≥®Â§ñÈÉ®ËÆæÂ§áÁîüÊàê‰∏≠Êñ≠Âπ∂ÈÄöËøáÊéßÂà∂Âô®Ë∑ØÁî±Âà∞Â§ÑÁêÜÂô®Ê†∏ÂøÉÁöÑÂÖ∏ÂûãÊÉÖÂÜµ„ÄÇ</p>
<p>External interrupts primarily originate from external devices,
though in advanced scenarios, internal devices and harts can also generate "external" interrupts
(e.g. when supervisor level injects external interrupts into virtualized supervisor level).
The following discussion focuses on the typical case where external devices generate interrupts that are routed through controllers to harts.</p>
<p><img src="./images/arch_interrupt_py.svg" alt="" /></p>
<p>ËØ¶ÁªÜÁöÑ‰∏≠Êñ≠ÈÄöË∑ØÂ¶Ç‰∏ãÔºàÊ≥®ÔºöÂú®ËØ≠Ë®ÄÊ∏ÖÊô∞ÂâçÊèê‰∏ãÔºåÊàë‰ª¨Â∞ÜÁúÅÁï•‚ÄúÂ§ñÈÉ®‚ÄùÔºâÔºö</p>
<ul>
<li>‰∏≠Êñ≠Êù•Ê∫ê‰∫éÁ∫øËÆæÂ§áÊàñMSIËÆæÂ§áÔºö
<ul>
<li>Á∫øËÆæÂ§áÈÄöË∑ØÔºö
<ul>
<li>‰∏≠Êñ≠Ë¢´ËΩ¨ÂèëÂà∞APLICÁöÑ<strong>‰∏≠Êñ≠Âüü</strong>„ÄÇ</li>
<li>ÊØè‰∏™ÂüüË¥üË¥£ÁÆ°ÁêÜÊüê‰∏ÄÁâπÊùÉÊÄÅÁöÑ‰∏ÄÁªÑÂ§ÑÁêÜÂô®Ê†∏ÂøÉÁöÑ‰∏≠Êñ≠„ÄÇ</li>
<li>ÂØπ‰∫éÂ§ßÂûãÂØπÁß∞Â§öÂ§ÑÁêÜÁ≥ªÁªüÔºåÈÄöÂ∏∏‰∏§‰∏™ÂüüÂ∞±Ë∂≥Â§ü‰∫Ü<sup class="footnote-reference"><a href="#two_interrupt_domains">1</a></sup>Ôºö
<ul>
<li>‰∏Ä‰∏™<strong>Êú∫Âô®ÊÄÅÂüü</strong>Ôºå</li>
<li>‰∏Ä‰∏™<strong>ÁõëÁÆ°ÊÄÅÂüü</strong>„ÄÇ</li>
</ul>
</li>
<li>ÂüüÈÅµÂæ™Â±ÇÁ∫ßÁªìÊûÑÔºö
<ul>
<li>ÊâÄÁ∫ø‰∏≠Êñ≠È¶ñÂÖàÂà∞ËææÊú∫Âô®ÊÄÅÂüü„ÄÇ</li>
<li>Ê†πÊçÆAPLICÁöÑÈÖçÁΩÆÔºåÊØè‰∏™‰∏≠Êñ≠ÂèØ‰ª•Ôºö
<ul>
<li>ËΩ¨Êç¢‰∏∫MSIÂπ∂ÈÄöËøáÊÄªÁ∫ø/ÁΩëÁªúËΩ¨ÂèëÁªôIMSICÔºå</li>
<li>ÂßîÊâòÁªôÂ≠êÂüüÔºåÁÑ∂ÂêéÈÅµÂæ™Á±ª‰ººÁöÑÂ§ÑÁêÜÊµÅÁ®ã„ÄÇ</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>MSIËÆæÂ§áÈÄöË∑ØÔºö
<ul>
<li>MSIÈÄöËøáÊÄªÁ∫ø/ÁΩëÁªúÁõ¥Êé•Ë∑ØÁî±Âà∞IMSIC„ÄÇ</li>
</ul>
</li>
</ul>
</li>
<li>IMSICÂ§ÑÁêÜÊµÅÁ®ãÔºö
<ul>
<li>ÊØè‰∏™Â§ÑÁêÜÂô®Ê†∏ÂøÉÈÄöÂ∏∏ÊúâÂÖ∂‰∏ìÁî®ÁöÑIMSIC„ÄÇ</li>
<li>ÊØè‰∏™IMSICÂåÖÂê´Â§ö‰∏™‰∏≠Êñ≠Êñá‰ª∂ÔºåÊØè‰∏™ÁâπÊùÉÊÄÅÂØπÂ∫î‰∏Ä‰∏™<strong>‰∏≠Êñ≠Êñá‰ª∂</strong><sup class="footnote-reference"><a href="#one_imsic_per_hart">2</a></sup>Ôºö
<ul>
<li>‰∏Ä‰∏™<strong>Êú∫Âô®ÊÄÅ</strong>Ôºå</li>
<li>‰∏Ä‰∏™<strong>ÁõëÁÆ°ÊÄÅ</strong>Ôºå</li>
<li>Â§ö‰∏™<strong>ËôöÊãüÂåñÁõëÁÆ°ÊÄÅ</strong>„ÄÇ</li>
</ul>
</li>
<li>ÊØè‰∏™‰∏≠Êñ≠Êñá‰ª∂Ôºö
<ul>
<li>Áª¥Êä§‰∏≠Êñ≠Áä∂ÊÄÅ(ÂæÖÂ§ÑÁêÜ„ÄÅ‰ΩøËÉΩÁ≠â)Ôºå</li>
<li>Ê†πÊçÆÈÖçÁΩÆÈÄöËøáÁ∫øË∑ØÂêëÂ§ÑÁêÜÂô®Ê†∏ÂøÉÂèëÂá∫‰∏≠Êñ≠‰ø°Âè∑„ÄÇ</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Here are the detailed interrupts paths (note: "external" is omitted where context is clear):</p>
<ul>
<li>Interrupts originate from either wired devices or MSI devices:
<ul>
<li>Wired device paths:
<ul>
<li>Interrupts are directed to APLIC's <strong>interrupt domains</strong>.</li>
<li>Each domain manages interrupts for a specific set of harts at a given privilege level.</li>
<li>For large symmetric multiprocessing systems, typically two domains suffice<sup class="footnote-reference"><a href="#two_interrupt_domains">1</a></sup>:
<ul>
<li>One <strong>machine-level domain</strong>,</li>
<li>One <strong>supervisor-level domain</strong>.</li>
</ul>
</li>
<li>Domains follow a hierarchical structure:
<ul>
<li>All wired interrupts fist arrive at the machine-level domain.</li>
<li>Based on APLIC configuration, each interrup is either:
<ul>
<li>Converted to MSI and forwarded to IMSIC via bus/network,</li>
<li>Delegated to child domains, which then follow similar processing.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>MSI device paths:
<ul>
<li>MSIs route directly to IMSIC via bus/network.</li>
</ul>
</li>
</ul>
</li>
<li>IMSIC processing:
<ul>
<li>Each hart typically has its dedicated IMSIC.</li>
<li>Each IMSIC contains multiple <strong>interrupt files</strong>, one per privilege level<sup class="footnote-reference"><a href="#one_imsic_per_hart">2</a></sup>:
<ul>
<li>One <strong>machine level</strong>,</li>
<li>One <strong>supervisor level</strong>,</li>
<li>Multiple <strong>virtualized supervisor levels</strong>.</li>
</ul>
</li>
<li>Each interrupt file:
<ul>
<li>Maintains interrup status (pending, enabled, ...),</li>
<li>Signals hart based on configuration via wire connection.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ÈÖçÁΩÆÈÄöË∑Øconfiguration-paths"><a class="header" href="#ÈÖçÁΩÆÈÄöË∑Øconfiguration-paths">ÈÖçÁΩÆÈÄöË∑ØÔºàConfiguration PathsÔºâ</a></h2>
<p>ÈÖçÁΩÆÊµÅÁ®ãÈÅµÂæ™‰∏§‰∏™‰∏çÂêåÁöÑÈÄöË∑ØÔºö</p>
<ul>
<li>IMSICÈÖçÁΩÆÔºö
<ul>
<li>ÊØè‰∏™Â§ÑÁêÜÂô®Ê†∏ÂøÉÂè™ÈÖçÁΩÆÂÖ∂‰∏ìÁî®ÁöÑIMSICÔºå</li>
<li>ÈÖçÁΩÆÈÄöËøáÁ∫øË∑ØËøûÊé•ËøõË°å„ÄÇ</li>
</ul>
</li>
<li>APLICÈÖçÁΩÆÔºö
<ul>
<li>ÊâÄÊúâÂ§ÑÁêÜÂô®Ê†∏ÂøÉÈÉΩÂèØ‰ª•ÈÖçÁΩÆAPLICÔºå</li>
<li>ÈÖçÁΩÆ‰ª•Ê∂àÊÅØÂΩ¢ÂºèÈÄöËøáÊÄªÁ∫ø‰º†Ëæì„ÄÇ</li>
</ul>
</li>
</ul>
<p>Configuration flow follows two distinct paths:</p>
<ul>
<li>IMSIC configuration:
<ul>
<li>Each hart configures only its dedicated IMSIC,</li>
<li>Configuration occurs through direct wire connection.</li>
</ul>
</li>
<li>APLIC Configuration:
<ul>
<li>All harts can configure APLIC,</li>
<li>Configuration transmitted via bus as messages.</li>
</ul>
</li>
</ul>
<p><img src="./images/arch_configure_py.svg" alt="" /></p>
<h2 id="ÂºïÁî®references"><a class="header" href="#ÂºïÁî®references">ÂºïÁî®ÔºàReferencesÔºâ</a></h2>
<ul>
<li>
<div class="footnote-definition" id="two_interrupt_domains"><sup class="footnote-definition-label">1</sup>
<p><em>The RISC-V Advanced Interrupt Architecture</em>: 4.2 Interrupt domains: Figure 4.</p>
</div>
</li>
<li>
<div class="footnote-definition" id="one_imsic_per_hart"><sup class="footnote-definition-label">2</sup>
<p><em>The RISC-V Advanced Interrupt Architecture</em>: 1.3.2. External interrupts with IMSICs.</p>
</div>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="imsic"><a class="header" href="#imsic">üì©IMSIC</a></h1>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="imsic.html#%E5%8D%95%E4%B8%AAimsic%E7%9A%84%E5%8A%9F%E8%83%BDindividual-imsic-functionality">Âçï‰∏™IMSICÁöÑÂäüËÉΩÔºàIndividual IMSIC FunctionalityÔºâ</a>
<ul>
<li><a href="imsic.html#imsic%E7%9A%84%E8%BE%93%E5%85%A5%E4%B8%8E%E8%BE%93%E5%87%BAimsic-io">IMSICÁöÑËæìÂÖ•‰∏éËæìÂá∫ÔºàIMSIC IOÔºâ</a></li>
<li><a href="imsic.html#%E4%B8%AD%E6%96%AD%E6%96%87%E4%BB%B6%E7%9A%84%E8%BE%93%E5%85%A5%E4%B8%8E%E8%BE%93%E5%87%BAinterrupt-file-io">‰∏≠Êñ≠Êñá‰ª∂ÁöÑËæìÂÖ•‰∏éËæìÂá∫ÔºàInterrupt File IOÔºâ</a></li>
<li><a href="imsic.html#%E4%B8%AD%E6%96%AD%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E5%AF%84%E5%AD%98%E5%99%A8interrupt-file-memory-mapped-registers">‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂÜÖÂ≠òÊò†Â∞ÑÂØÑÂ≠òÂô®ÔºàInterrupt File Memory-mapped RegistersÔºâ</a></li>
<li><a href="imsic.html#%E4%B8%AD%E6%96%AD%E6%96%87%E4%BB%B6%E5%86%85%E9%83%A8%E7%9A%84%E5%AF%84%E5%AD%98%E5%99%A8interrupt-file-internal-registers">‰∏≠Êñ≠Êñá‰ª∂ÂÜÖÈÉ®ÁöÑÂØÑÂ≠òÂô®ÔºàInterrupt File Internal RegistersÔºâ</a></li>
</ul>
</li>
<li><a href="imsic.html#%E5%A4%9A%E4%B8%AAimsic%E7%9A%84%E7%BB%84%E7%BB%87%E5%BD%A2%E5%BC%8Fmultiple-imsics-arrangement">Â§ö‰∏™IMSICÁöÑÁªÑÁªáÂΩ¢ÂºèÔºàMultiple IMSICs ArrangementÔºâ</a>
<ul>
<li><a href="imsic.html#imsic%E5%9C%B0%E5%9D%80%E5%AD%97%E6%AE%B5imsic-address-fields">IMSICÂú∞ÂùÄÂ≠óÊÆµÔºàIMSIC Address FieldsÔºâ</a></li>
<li><a href="imsic.html#imsic%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9Fimsic-memory-regions">IMSICÂÜÖÂ≠òÂå∫ÂüüÔºàIMSIC Memory RegionsÔºâ</a></li>
</ul>
</li>
</ul>
<!-- vim-markdown-toc -->
<p>Âú®ÂÖ∏ÂûãÁöÑRISC-VÁ≥ªÁªü‰∏≠ÔºåÊØè‰∏™Â§ÑÁêÜÂô®Ê†∏ÂøÉÈÉΩÈÖçÊúâ‰∏ìÁî®ÁöÑIMSIC„ÄÇ
IMSICÊâßË°å‰∏â‰∏™‰∏ªË¶ÅÂäüËÉΩ:</p>
<ul>
<li>ÈÄöËøáÂÜÖÂ≠òÊò†Â∞ÑÂØÑÂ≠òÂô®Êé•Êî∂MSIÔºå</li>
<li>‰∏∫ÂÖ∂ÂÖ≥ËÅîÁöÑÂ§ÑÁêÜÂô®Ê†∏ÂøÉÁîüÊàê‰∏≠Êñ≠Ôºå</li>
<li>ÁÆ°ÁêÜÂ§ÑÁêÜÂô®Ê†∏ÂøÉÊâÄÈúÄÁöÑAIAÊéßÂà∂ÂØÑÂ≠òÂô®„ÄÇ</li>
</ul>
<p>In a typical RISC-V system, each hart is paired with its dedicated IMSIC.
The IMSIC performs three main functions:</p>
<ul>
<li>Receives MSIs through memory-mapped registers,</li>
<li>Generates interrupts for its associated hart,</li>
<li>Manages AIA CSRs under hart control.</li>
</ul>
<p>Âú®ÂØπÁß∞Â§öÂ§ÑÁêÜÁ≥ªÁªü‰∏≠ÔºåÂ§ö‰∏™‚ÄúÊ†∏-IMSIC‚ÄùÂØπÂèØ‰ª•ÂàíÂàÜÊàêÁªÑÔºå
ÊØèÁªÑÂåÖÂê´Áõ∏ÂêåÊï∞ÈáèÁöÑÊ†∏-IMSICÂØπ„ÄÇ</p>
<p>In symmetric multiprocessing systems, multiple harts-IMSIC pairs can be organized into groups,
with each group containing an equal number of pairs.</p>
<h2 id="Âçï‰∏™imsicÁöÑÂäüËÉΩindividual-imsic-functionality"><a class="header" href="#Âçï‰∏™imsicÁöÑÂäüËÉΩindividual-imsic-functionality">Âçï‰∏™IMSICÁöÑÂäüËÉΩÔºàIndividual IMSIC FunctionalityÔºâ</a></h2>
<h3 id="imsicÁöÑËæìÂÖ•‰∏éËæìÂá∫imsic-io"><a class="header" href="#imsicÁöÑËæìÂÖ•‰∏éËæìÂá∫imsic-io">IMSICÁöÑËæìÂÖ•‰∏éËæìÂá∫ÔºàIMSIC IOÔºâ</a></h3>
<p>IMSIC‰∏éÂÖ∂Â§ÑÁêÜÂô®Ê†∏ÂøÉÁ¥ßÂØÜËÄ¶ÂêàÔºå
Áõ¥Êé•‰ΩøÁî®Á∫øË∑ØËøûÊé•ËÄå‰∏çÊòØÊÄªÁ∫ø/ÁΩëÁªúËøõË°å‰ø°ÊÅØ‰º†Ëæì„ÄÇ
ÂÖ∂ÂÖ≥ÈîÆ‰ø°Âè∑ÂåÖÊã¨:</p>
<ul>
<li><code>pendings</code>: ÊØè‰∏™‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂæÖÂ§ÑÁêÜ‰∏≠Êñ≠Áä∂ÊÄÅ„ÄÇ</li>
<li><code>{m,s,vs}topei</code>: ÊØè‰∏™ÁâπÊùÉÊÄÅ‰∏≠Ôºå‰ºòÂÖàÁ∫ßÊúÄÈ´òÁöÑÂ§ñÈÉ®‰∏≠Êñ≠Âè∑„ÄÇ</li>
<li><code>{m.s,vs}iselect</code>: ÊØè‰∏™ÁâπÊùÉÊÄÅ‰∏≠ÔºåÈó¥Êé•ËÆøÈóÆÊéßÂà∂ÂØÑÂ≠òÂô®ÁöÑÂú∞ÂùÄ„ÄÇ</li>
<li><code>{m,s,vs}ireg</code>: ÊØè‰∏™ÁâπÊùÉÊÄÅ‰∏≠ÔºåÈó¥Êé•ËÆøÈóÆÊéßÂà∂ÂØÑÂ≠òÂô®ÊâÄËØªÂÜôÁöÑÊï∞ÊçÆ„ÄÇ</li>
<li><code>vgein</code>: ËôöÊãüÂåñÁõëÁÆ°ÊÄÅÁöÑÈÄâÊã©‰ø°Âè∑„ÄÇ</li>
</ul>
<p>The IMSIC is tightly coupled with its hart,
directly using wire connection rather than bus/network for information transfer.
Key signals include:</p>
<ul>
<li><code>pendings</code>: Pending interrupt status for each interrupt file.</li>
<li><code>{m,s,vs}topei</code>: Top external interrupt ID for each privilege level.</li>
<li><code>{m.s,vs}iselect</code>: CSR indirect access address for each privilege level.</li>
<li><code>{m,s,vs}ireg</code>: Read and write data for indirect CSR access for each privilege level.</li>
<li><code>vgein</code>: Virtualized supervisor level selector.</li>
</ul>
<p><img src="./images/imsic_py.svg" alt="" /></p>
<h3 id="‰∏≠Êñ≠Êñá‰ª∂ÁöÑËæìÂÖ•‰∏éËæìÂá∫interrupt-file-io"><a class="header" href="#‰∏≠Êñ≠Êñá‰ª∂ÁöÑËæìÂÖ•‰∏éËæìÂá∫interrupt-file-io">‰∏≠Êñ≠Êñá‰ª∂ÁöÑËæìÂÖ•‰∏éËæìÂá∫ÔºàInterrupt File IOÔºâ</a></h3>
<p>‰∏Ä‰∏™IMSICË¥üË¥£ÁÆ°ÁêÜÂÖ∂Â§ÑÁêÜÂô®Ê†∏ÂøÉ‰∏≠ÁöÑÊâÄÊúâÁâπÊùÉÊÄÅÔºå
ÂåÖÊã¨Ôºö‰∏Ä‰∏™Êú∫Âô®ÊÄÅ„ÄÅ‰∏Ä‰∏™ÁõëÁÆ°ÊÄÅÂíåÂ§ö‰∏™ËôöÊãüÂåñÁõëÁÆ°ÊÄÅ„ÄÇ
Áî±‰∫éÊØè‰∏™ÊÄÅÁöÑË°å‰∏∫Âú®‰∏ÄËà¨ÊÉÖÂÜµ‰∏ãÊòØÁõ∏ÂêåÁöÑÔºåAIAËßÑËåÉÂ∞ÜËøô‰∫õÂäüËÉΩÊ®°ÂùóÂåñÊàêÁã¨Á´ã‰∏îÂèØÈáçÁî®ÁöÑÁªÑ‰ª∂ÔºåÁß∞‰∏∫‰∏≠Êñ≠Êñá‰ª∂„ÄÇ
ÊØè‰∏™‰∏≠Êñ≠Êñá‰ª∂‰∏éIMSIC‰∫§Êç¢‰∏éÁâπÊùÉÊÄÅÊó†ÂÖ≥ÁöÑ‰ø°ÊÅØ:</p>
<ul>
<li><code>pending</code>: ËØ•‰∏≠Êñ≠Êñá‰ª∂ÁöÑ‰∏≠Êñ≠Áä∂ÊÄÅ„ÄÇ</li>
<li><code>topei</code>: ËØ•‰∏≠Êñ≠Êñá‰ª∂‰∏≠Ôºå‰ºòÂÖàÁ∫ßÊúÄÈ´òÁöÑÂ§ñÈÉ®‰∏≠Êñ≠Âè∑„ÄÇ</li>
<li><code>iselect</code>: ËØ•‰∏≠Êñ≠Êñá‰ª∂‰∏≠ÔºåÈó¥Êé•ËÆøÈóÆÊéßÂà∂ÂØÑÂ≠òÂô®ÁöÑÂú∞ÂùÄ„ÄÇ</li>
<li><code>ireg</code>: ËØ•‰∏≠Êñ≠Êñá‰ª∂‰∏≠ÔºåÈó¥Êé•ËÆøÈóÆÊéßÂà∂ÂØÑÂ≠òÂô®ÊâÄËØªÂÜôÁöÑÊï∞ÊçÆ„ÄÇ</li>
</ul>
<p>One IMSIC manages all privilege levels in its hart,
including: one machine level, one supervisor level, and multiple virtualized supervisor levels.
As the behaviors of each level are identical in general, the AIA specification modularizes these functionalities of each level into independent and reusable components, called interrupt files.
Each interrupt file exchanges privilege-agnostic information with IMSIC:</p>
<ul>
<li><code>pending</code>: Interrupt pending status for this interrupt file.</li>
<li><code>topei</code>: Top external interrupt ID for this interrupt file.</li>
<li><code>iselect</code>: CSR indirect access address for this interrupt file.</li>
<li><code>ireg</code>: Read and write data for indirect CSR access for this interrupt file.</li>
</ul>
<h3 id="‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂÜÖÂ≠òÊò†Â∞ÑÂØÑÂ≠òÂô®interrupt-file-memory-mapped-registers"><a class="header" href="#‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂÜÖÂ≠òÊò†Â∞ÑÂØÑÂ≠òÂô®interrupt-file-memory-mapped-registers">‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂÜÖÂ≠òÊò†Â∞ÑÂØÑÂ≠òÂô®ÔºàInterrupt File Memory-mapped RegistersÔºâ</a></h3>
<p>ÊØè‰∏™‰∏≠Êñ≠Êñá‰ª∂ÂåÖÂê´‰∏Ä‰∏™4KBÂÜÖÂ≠òÈ°µÔºåÁî®‰∫éÊé•Êî∂Êù•Ëá™ÊÄªÁ∫ø/ÁΩëÁªúÁöÑÊ∂àÊÅØ„ÄÇ
ÂÜÖÂ≠òÈ°µÂÜÖ‰ªÖÂåÖÂê´‰∏Ä‰∏™4BÂÜÖÂ≠òÊò†Â∞ÑÂØÑÂ≠òÂô®:</p>
<ul>
<li><code>seteipnum</code>: ‰Ωç‰∫éÂÅèÁßªÈáè0x0Â§ÑÔºåÊé•Êî∂‰º†ÂÖ•ÁöÑ‰∏≠Êñ≠Âè∑„ÄÇ</li>
</ul>
<p>Each interrupt file includes a 4KB memory page for receiving messages from bus/network.
The memory page including only one 4B memory-mapped register:</p>
<ul>
<li><code>seteipnum</code>: Located at offset of 0x0, receiving incoming interrupt IDs.</li>
</ul>
<h3 id="‰∏≠Êñ≠Êñá‰ª∂ÂÜÖÈÉ®ÁöÑÂØÑÂ≠òÂô®interrupt-file-internal-registers"><a class="header" href="#‰∏≠Êñ≠Êñá‰ª∂ÂÜÖÈÉ®ÁöÑÂØÑÂ≠òÂô®interrupt-file-internal-registers">‰∏≠Êñ≠Êñá‰ª∂ÂÜÖÈÉ®ÁöÑÂØÑÂ≠òÂô®ÔºàInterrupt File Internal RegistersÔºâ</a></h3>
<p>ÊâÄÊúâ‰∏äËø∞Êé•Âè£ÈÉΩ‰∏é‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂÜÖÈÉ®ÂØÑÂ≠òÂô®‰∫§‰∫í„ÄÇ
ÂÖ≥ÈîÆÁöÑÂÜÖÈÉ®ÂØÑÂ≠òÂô®ÂåÖÊã¨:</p>
<ul>
<li><code>eip[intSrcNum‰Ωç]</code>: Ë°®Á§∫ËØ•‰∏≠Êñ≠ÊòØÂê¶ÂæÖÂ§ÑÁêÜ„ÄÇ</li>
<li><code>eie[intSrcNum‰Ωç]</code>: Ë°®Á§∫ËØ•‰∏≠Êñ≠ÊòØÂê¶‰ΩøËÉΩ„ÄÇ</li>
</ul>
<p>Each interrupt file maintains internal registers that interact with the interfaces above.
The key internal registers consist of:</p>
<ul>
<li><code>eip[intSrcNum bits]</code>: Whether this interrupt is pending.</li>
<li><code>eie[intSrcNum bits]</code>: Whether this interrupt is enabled.</li>
</ul>
<h2 id="Â§ö‰∏™imsicÁöÑÁªÑÁªáÂΩ¢Âºèmultiple-imsics-arrangement"><a class="header" href="#Â§ö‰∏™imsicÁöÑÁªÑÁªáÂΩ¢Âºèmultiple-imsics-arrangement">Â§ö‰∏™IMSICÁöÑÁªÑÁªáÂΩ¢ÂºèÔºàMultiple IMSICs ArrangementÔºâ</a></h2>
<p>Âú®Â§ßÂûãÁ≥ªÁªü‰∏≠ÔºåÊ†∏-IMSICÂØπÂèØ‰ª•ÂàÜÊàêÂ§öÁªÑ„ÄÇ
‰∏ãÂõæÊòæÁ§∫‰∫Ü‰∏Ä‰∏™ÂØπÁß∞ÁöÑ4Ê†∏-IMSICÁ≥ªÁªü„ÄÇ
Ëøô4ÂØπË¢´ÂàÜ‰∏∫2<strong>ÁªÑ</strong>ÔºåÊØèÁªÑÂåÖÂê´2‰∏™<strong>ÊàêÂëò</strong>(hart-IMSICÂØπ)„ÄÇ</p>
<p>In a large system, hart-IMSIC pairs can be divided into groups.
The below figure shows a symmetric 4-hart-IMSIC system.
These 4 pairs are divided into 2 <strong>groups</strong>, and each group contains 2 <strong>members</strong> (hart-IMSIC pairs).</p>
<p><img src="./images/imsics_arrangement_py.svg" alt="" /></p>
<h3 id="imsicÂú∞ÂùÄÂ≠óÊÆµimsic-address-fields"><a class="header" href="#imsicÂú∞ÂùÄÂ≠óÊÆµimsic-address-fields">IMSICÂú∞ÂùÄÂ≠óÊÆµÔºàIMSIC Address FieldsÔºâ</a></h3>
<p>‰∏∫‰∫ÜÊîØÊåÅÁâ©ÁêÜÂÜÖÂ≠ò‰øùÊä§(physical memory protection, PMP)ÔºåÁõ∏ÂêåÁâπÊùÉÊÄÅÁöÑ‰∏≠Êñ≠Êñá‰ª∂‰Ωç‰∫éÂêå‰∏ÄÂÜÖÂ≠òÂå∫Âüü:</p>
<ul>
<li>Êú∫Âô®ÊÄÅÂÜÖÂ≠òÂå∫Âüü:
<ul>
<li>ÊØè‰∏™Â§ÑÁêÜÂô®Ê†∏ÂøÉÂØπÂ∫î‰∏Ä‰∏™Êú∫Âô®ÊÄÅ‰∏≠Êñ≠Êñá‰ª∂</li>
</ul>
</li>
<li>ÁõëÁÆ°ÊÄÅÂÜÖÂ≠òÂå∫Âüü:
<ul>
<li>ÊØè‰∏™Â§ÑÁêÜÂô®Ê†∏ÂøÉÂØπÂ∫î‰∏Ä‰∏™ÁõëÁÆ°ÊÄÅ‰∏≠Êñ≠Êñá‰ª∂,</li>
<li>ÊØè‰∏™Â§ÑÁêÜÂô®Ê†∏ÂøÉÂØπÂ∫îÂ§ö‰∏™ËôöÊãüÂåñÁõëÁÆ°ÊÄÅ‰∏≠Êñ≠Êñá‰ª∂„ÄÇ</li>
</ul>
</li>
</ul>
<p>To support physical memory protection (PMP), interrupt files of the same privilege level are located in a same memory region:</p>
<ul>
<li>Machine-level memory region:
<ul>
<li>One machine-level interrupt file per hart</li>
</ul>
</li>
<li>Supervisor-level memory region:
<ul>
<li>One supervisor-level interrupt file per hart,</li>
<li>Multiple virtualized supervisor-level interrupt files per hart.</li>
</ul>
</li>
</ul>
<p>Âõ†Ê≠§ÔºåÊØè‰∏™Â§ÑÁêÜÂô®Ê†∏ÂøÉÂú®Êú∫Âô®ÊÄÅÂÜÖÂ≠òÂå∫ÂüüÂè™Âç†‰∏ÄÈ°µÔºå‰ΩÜÂú®ÁõëÁÆ°ÊÄÅÂÜÖÂ≠òÂå∫ÂüüÂç†Â§öÈ°µÔºå
Áî±<strong>ÂÆ¢Êà∑Âè∑</strong>ÔºàÁõëÁÆ°ÊÄÅ‰∏∫0ÔºåËôöÊãüÂåñÁõëÁÆ°ÊÄÅ‰∏∫1„ÄÅ2„ÄÅ3„ÄÅ...)Á¥¢Âºï„ÄÇ
ÈúÄË¶ÅÂõõ‰∏™Â≠óÊÆµÊù•Á°ÆÂÆö‰∏Ä‰∏™IMSICÁöÑÂÜÖÂ≠òÈ°µÁöÑÂú∞ÂùÄÔºö</p>
<ul>
<li>ÁâπÊùÉÊÄÅÔºöÊú∫Âô®ÊÄÅÊàñÁõëÁÆ°ÊÄÅ„ÄÇ</li>
<li>ÁªÑÂè∑ÔºöËØ•IMSICÊâÄÂ±ûÁöÑÁªÑ„ÄÇ</li>
<li>ÊàêÂëòÂè∑ÔºöËØ•IMSICÊâÄÂ±ûÁöÑÊàêÂëò„ÄÇ</li>
<li>ÂÆ¢Êà∑Âè∑ÔºöÁõëÁÆ°ÊÄÅÊàñËôöÊãüÂåñÁõëÁÆ°ÊÄÅ‰πã‰∏Ä„ÄÇ</li>
</ul>
<p>Thus, each hart has only one page in machine-level memory region and multiple pages in supervisor-level memory region,
indexed by a <strong>guest ID</strong> (0 for supervisor-level, 1,2,3,... for virtualized supervisor level).
When determining the memory page address for a given IMSIC, four fields are needed:</p>
<ul>
<li>Privilege Level: Machine level or supervisor level.</li>
<li>Group ID: The group to which this IMSIC belongs.</li>
<li>Member ID: The member to which this IMSIC belongs.</li>
<li>Guest ID: Supervisor level or one of the virtualized supervisor levels.</li>
</ul>
<p><img src="./images/imsic_addr.svg" alt="" /></p>
<p>Êú∫Âô®ÊÄÅ‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂú∞ÂùÄË°®ËææÂºè‰∏∫Ôºö</p>
<p>The formal expression for a machine-level interrupt file address:</p>
<p>$$
\begin{align}
mIntFileAddr =
&amp; mBaseAddr \\
&amp; + groupID \times 2^{mGroupStrideWidth} \\
&amp; + memberID \times 2^{mMemberStrideWidth} \\
&amp; + guestID \times 4K
\end{align}
$$</p>
<p>ËôöÊãüÂåñÁõëÁÆ°ÊÄÅ‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂú∞ÂùÄË°®ËææÂºè‰∏∫Ôºö</p>
<p>The formal expression for a virtualized supervisor-level interrupt file address:</p>
<p>$$
\begin{align}
vsIntFileAddr =
&amp; vsBaseAddr \\
&amp; + groupID \times 2^{vsGroupStrideWidth} \\
&amp; + memberID \times 2^{vsMemberStrideWidth} \\
&amp; + guestID \times 4K
\end{align}
$$</p>
<p>ÊåâÁÖßAIAËßÑËåÉÁöÑË¶ÅÊ±ÇÔºå<code>vsGroupStrideWidth</code>‰∏é<code>mGroupStrideWidth</code>Áõ∏Âêå„ÄÇ
Êõ¥Â§öËØ¶ÁªÜ‰ø°ÊÅØÔºåËØ∑ÂèÇÈòÖAIAËßÑËåÉ<sup class="footnote-reference"><a href="#imsic_memory_region">1</a></sup>„ÄÇ</p>
<p>As required by the AIA specification, the <code>vsGroupStrideWidth</code> is the same as the <code>mGroupStrideWidth</code>.
For more details, please refer to the AIA specification<sup class="footnote-reference"><a href="#imsic_memory_region">1</a></sup>.</p>
<h3 id="imsicÂÜÖÂ≠òÂå∫Âüüimsic-memory-regions"><a class="header" href="#imsicÂÜÖÂ≠òÂå∫Âüüimsic-memory-regions">IMSICÂÜÖÂ≠òÂå∫ÂüüÔºàIMSIC Memory RegionsÔºâ</a></h3>
<p>Êú∫Âô®ÂíåÁõëÁÆ°ÊÄÅÁöÑÂÜÖÂ≠òÂå∫ÂüüÂ¶Ç‰∏ãÊâÄÁ§∫„ÄÇ</p>
<p>The memory regions for machine and supervisor levels are shown as below.</p>
<p><img src="./images/imsic_addr_space.svg" alt="" /></p>
<p>ËøôÈáåÂ±ïÁ§∫‰∏Ä‰∏™ÂÖ∑‰ΩìÁöÑ‰æãÂ≠ê„ÄÇ
ÂÅáËÆæÊú∫Âô®ÊÄÅÂíåÁõëÁÆ°ÊÄÅÁöÑÂÜÖÂ≠òÂå∫ÂüüÂü∫Âú∞ÂùÄÂàÜÂà´‰∏∫<code>0x6100_0000</code>Âíå<code>0x8290_0000</code>ÔºåÈÇ£‰πàÊØè‰∏™‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂú∞ÂùÄ‰∏∫Ôºö</p>
<p>Here is a concrete example.
Assuming the base addresses for machine-level and supervisor-level memory regions are <code>0x6100_0000</code> and <code>0x8290_0000</code>, respectively,
the addresses for each interrupt file are:</p>
<ul>
<li>Machine-level interrupt files:
<ul>
<li>IMSIC00: <code>[0x61000000, 0x61000fff]</code></li>
<li>IMSIC01: <code>[0x61001000, 0x61001fff]</code></li>
<li>IMSIC10: <code>[0x61008000, 0x61008fff]</code></li>
<li>IMSIC11: <code>[0x61009000, 0x61009fff]</code></li>
</ul>
</li>
<li>Supervisor-level interrupt files:
<ul>
<li>IMSIC00: <code>[0x82900000, 0x82903fff]</code></li>
<li>IMSIC01: <code>[0x82904000, 0x82907fff]</code></li>
<li>IMSIC10: <code>[0x82908000, 0x8290bfff]</code></li>
<li>IMSIC11: <code>[0x8290c000, 0x8290ffff]</code></li>
</ul>
</li>
</ul>
<div class="footnote-definition" id="imsic_memory_region"><sup class="footnote-definition-label">1</sup>
<p>The RISC-V Advanced Interrupt Architecture: 3.6. Arrangement of the memory regions of multiple interrupt files</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="aplic"><a class="header" href="#aplic">üß∂APLIC</a></h1>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="aplic.html#%E5%9F%9Fdomain">ÂüüÔºàDomainÔºâ</a>
<ul>
<li><a href="aplic.html#%E5%86%85%E9%83%A8%E5%AF%84%E5%AD%98%E5%99%A8internal-registers">ÂÜÖÈÉ®ÂØÑÂ≠òÂô®ÔºàInternal RegistersÔºâ</a></li>
</ul>
</li>
</ul>
<!-- vim-markdown-toc -->
<p>Âú®Âü∫‰∫éÊ∂àÊÅØÁöÑ‰∏≠Êñ≠Ê®°Âºè‰∏ãÔºåAPLICÂ∞Ü‰º†ÁªüÁöÑÁ∫ø‰∏≠Êñ≠ËΩ¨Êç¢‰∏∫MSI„ÄÇ
‰∏∫‰∫ÜÊèêÈ´òÊïàÁéáÔºåÈô§ÈùûËÆæÂ§áÂú®Áâ©ÁêÜ‰∏äÊòØÂàÜÂºÄÁöÑÔºà‰æãÂ¶ÇÂú®‰∏çÂêåÁöÑËäØÁâáÁªÑ‰∏äÔºâÔºåÂçï‰∏™APLICÂÆû‰æãÂç≥ÂèØÊúçÂä°ÊâÄÊúâÂ§ÑÁêÜÂô®Ê†∏ÂøÉ„ÄÇ</p>
<p>In message-based interrupt mode, the APLIC converts traditional wired interrupts into MSIs.
For efficiency, a single APLIC instance should serve all harts, unless devices are physically separated (e.g. on different chiplets).</p>
<h2 id="Âüüdomain"><a class="header" href="#Âüüdomain">ÂüüÔºàDomainÔºâ</a></h2>
<p>APLICÂÆûÁé∞‰∫ÜÂàÜÂ±ÇÁöÑÂüüÁªìÊûÑÊù•ÁÆ°ÁêÜ‰∏çÂêåÁöÑÁâπÊùÉÊÄÅ:</p>
<ul>
<li>Ê†πÂüüÔºàÊú∫Âô®ÊÄÅÔºâÁõ¥Êé•Êé•Êî∂ÊâÄÁ∫ø‰∏≠Êñ≠,</li>
<li>Â≠êÂüü‰ªéÂÖ∂Áà∂ÂüüÊé•Êî∂ÂßîÊâòÁöÑ‰∏≠Êñ≠,</li>
<li>ÁõëÁÆ°ÊÄÅÂüüÂèØ‰ª•Â§ÑÁêÜÁõëÁÆ°ÊÄÅÂíåËôöÊãüÂåñÁõëÁÆ°ÊÄÅ‰∏≠Êñ≠„ÄÇ</li>
</ul>
<p>The APLIC implements a hierarchical domain structure to manage different privilege levels:</p>
<ul>
<li>The root domain (machine level) directly receives all wired interrupts,</li>
<li>Child domains receive delegated interrupts from their parent domains,</li>
<li>A supervisor-level domain can handle both supervisor-level and virtualized supervisor-level interrupts.</li>
</ul>
<p>ÂØπ‰∫éÂ§ßÂûãÂØπÁß∞Â§öÂ§ÑÁêÜÁ≥ªÁªüÔºåÈÄöÂ∏∏‰∏§‰∏™ÂüüÁöÑÈÖçÁΩÆÂ∞±Ë∂≥Â§ü‰∫ÜÔºö</p>
<ul>
<li>‰∏Ä‰∏™Êú∫Âô®ÊÄÅÂüü,</li>
<li>‰∏Ä‰∏™ÁõëÁÆ°ÊÄÅÂüü„ÄÇ</li>
</ul>
<p>For large symmetric multiprocessing systems, a two-domain configuration typically suffices:</p>
<ul>
<li>One machine-level domain,</li>
<li>One supervisor-level domain.</li>
</ul>
<p><img src="./images/aplic.svg" alt="" /></p>
<h3 id="ÂÜÖÈÉ®ÂØÑÂ≠òÂô®internal-registers"><a class="header" href="#ÂÜÖÈÉ®ÂØÑÂ≠òÂô®internal-registers">ÂÜÖÈÉ®ÂØÑÂ≠òÂô®ÔºàInternal RegistersÔºâ</a></h3>
<p>APLICÂú®ÂÜÖÈÉ®ÂØÑÂ≠òÂô®‰∏≠Áª¥Êä§‰∏≠Êñ≠Áä∂ÊÄÅÔºåÂåÖÊã¨‰∏§‰∏™ÂÖ≥ÈîÆÂØÑÂ≠òÂô®Ôºö</p>
<ul>
<li><code>ip[intSrcNum‰Ωç]</code>: ‰∏≠Êñ≠ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅÂØÑÂ≠òÂô®,</li>
<li><code>ie[intSrcNum‰Ωç]</code>: ‰∏≠Êñ≠‰ΩøËÉΩÊéßÂà∂ÂØÑÂ≠òÂô®„ÄÇ</li>
</ul>
<p>APLIC maintains interrupt status in internal registers, including two critical registers:</p>
<ul>
<li><code>ip[intSrcNum bits]</code>: Interrupt pending status registers,</li>
<li><code>ie[intSrcNum bits]</code>: Interrupt enable control registers.</li>
</ul>
<p>Ëøô‰∫õÂØÑÂ≠òÂô®ÈÄöËøáÂÜÖÂ≠òÊò†Â∞ÑÊé•Âè£ËøõË°åÊéßÂà∂„ÄÇ
ÊúâÂÖ≥ËØ¶ÁªÜÁöÑÂØÑÂ≠òÂô®ËßÑËåÉÔºåËØ∑ÂèÇÈòÖAIAËßÑËåÉ<sup class="footnote-reference"><a href="#aplic_mem_regs">1</a></sup>„ÄÇ</p>
<p>These registers are controlled through memory-mapped interfaces.
For detailed register specifications, refer to the AIA specification<sup class="footnote-reference"><a href="#aplic_mem_regs">1</a></sup>.</p>
<p><strong>Á´û‰∫âÊù°‰ª∂</strong>Ôºà<strong>Race Conditions</strong>Ôºâ</p>
<p><code>ip</code>ÂØÑÂ≠òÂô®ÂèØ‰ª•Ë¢´Â§ö‰∏™Êù•Ê∫ê‰øÆÊîπÔºå‰ªéËÄå‰∫ßÁîüÊΩúÂú®ÁöÑÁ´û‰∫âÊù°‰ª∂„ÄÇ
AIAËßÑËåÉÊ≤°ÊúâËßÑÂÆöAPLICÂú®ËøôÁßçÁ´û‰∫âÊù°‰ª∂‰∏ãÁöÑË°å‰∏∫„ÄÇ
ChiselAIAÂÆûÁé∞‰∫Ü‰∏Ä‰∏™Âü∫‰∫é‰ºòÂÖàÁ∫ßÁöÑËß£ÂÜ≥Êú∫Âà∂„ÄÇ
‰ºòÂÖàÁ∫ß(‰ªéÈ´òÂà∞‰Ωé):</p>
<ul>
<li>APLICÂÜÖÈÉ®Êìç‰ΩúÔºöÂèëÈÄÅMSIÂêéÊ∏ÖÈô§<code>ip</code>Ôºå</li>
<li>Á∫øËÆæÂ§áÊìç‰ΩúÔºöÈÄöËøá<code>intSrc</code>ËÆæÁΩÆ<code>ip</code>Ôºå</li>
<li>Â§ÑÁêÜÂô®Ê†∏ÂøÉÊìç‰ΩúÔºöÈÄöËøáÂÜÖÂ≠òÊò†Â∞ÑÂØÑÂ≠òÂô®ËÆæÁΩÆ/Ê∏ÖÈô§<code>ip</code>„ÄÇ</li>
</ul>
<p>The <code>ip</code> registers can be modified by multiple sources, creating potential race conditions.
The AIA specification does not specify the APLIC behaviors under this race condition.
ChiselAIA implements a priority-based resolution mechanism.
Priority levels (highest to lowest):</p>
<ul>
<li>APLIC internal operations: Clearing <code>ip</code> after sending an MSI,</li>
<li>Wired device operations: Setting <code>ip</code> via <code>intSrc</code>,</li>
<li>Hart operations: Setting/Clearing <code>ip</code> via memory mapped registers.</li>
</ul>
<p>È´ò‰ºòÂÖàÁ∫ßÊìç‰Ωú‰ºöË¶ÜÁõñ‰Ωé‰ºòÂÖàÁ∫ßÊìç‰Ωú„ÄÇ
Êàë‰ª¨Êé®ËçêÈÄöËøáÁºñÁ®ãÁöÑÊñπÂºèÈÅøÂÖçÁ´û‰∫âÊù°‰ª∂Ôºö
Âú®ÈÄöËøáÂÜÖÂ≠òÊò†Â∞ÑÂØÑÂ≠òÂô®‰øÆÊîπÁõ∏Â∫îÁöÑ<code>ip</code>‰πãÂâçÔºåÊñ≠ÂºÄÁ∫øËÆæÂ§á„ÄÇ</p>
<p>Higher priority operations override the lower priority ones.
We recommend to avoid race conditions through programming:
detaching the wired device before modifying corresponding <code>ip</code> through memory-mapped registers.</p>
<div class="footnote-definition" id="aplic_mem_regs"><sup class="footnote-definition-label">1</sup>
<p>The RISC-V Advanced Interrupt Architecture: 4.5. Memory-mapped control region for an interrupt domain</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ÈõÜÊàêÊåáÂçóintegration-guide"><a class="header" href="#ÈõÜÊàêÊåáÂçóintegration-guide">üß≠ÈõÜÊàêÊåáÂçóÔºàIntegration GuideÔºâ</a></h1>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="integration.html#%E6%A6%82%E8%A7%88overview">Ê¶ÇËßàÔºàOverviewÔºâ</a></li>
<li><a href="integration.html#%E5%8F%82%E6%95%B0parameters">ÂèÇÊï∞ÔºàParametersÔºâ</a></li>
<li><a href="integration.html#%E5%AE%9E%E4%BE%8B%E5%8C%96instantiation">ÂÆû‰æãÂåñÔºàInstantiationÔºâ</a>
<ul>
<li><a href="integration.html#span-stylecolorred%E5%85%B3%E4%BA%8Ehartindexabout-hartindexspan"><span style="color:red;">ÂÖ≥‰∫éhartIndexÔºàAbout hartIndexÔºâ</span></a></li>
</ul>
</li>
<li><a href="integration.html#%E7%A4%BA%E4%BE%8Bexamples">Á§∫‰æãÔºàExamplesÔºâ</a>
<ul>
<li><a href="integration.html#%E7%AE%80%E5%8D%95%E7%9A%844%E6%A0%B8%E7%B3%BB%E7%BB%9Fa-simple-4-hart-system">ÁÆÄÂçïÁöÑ4Ê†∏Á≥ªÁªüÔºàA Simple 4-Hart SystemÔºâ</a></li>
<li><a href="integration.html#%E5%88%86%E7%BB%84%E7%9A%844%E6%A0%B8%E7%B3%BB%E7%BB%9Fa-grouped-4-hart-system">ÂàÜÁªÑÁöÑ4Ê†∏Á≥ªÁªüÔºàA Grouped 4-Hart SystemÔºâ</a></li>
</ul>
</li>
</ul>
<!-- vim-markdown-toc -->
<p>Êú¨ÊåáÂçó‰ªãÁªçÂ¶Ç‰ΩïÂ∞ÜChiselAIAÈõÜÊàêÂà∞RISC-VÁ≥ªÁªü‰∏≠„ÄÇ</p>
<p>This guide introduces the integration process of ChiselAIA into a RISC-V system.</p>
<h2 id="Ê¶ÇËßàoverview"><a class="header" href="#Ê¶ÇËßàoverview">Ê¶ÇËßàÔºàOverviewÔºâ</a></h2>
<p>ÈõÜÊàêÊ∂âÂèä3‰∏™ScalaÊñá‰ª∂Âíå4‰∏™ScalaÁ±ªÔºö</p>
<ul>
<li><code>TLAPLIC</code>Ôºà@<code>APLIC.scala</code>ÔºâÔºöÂü∫‰∫éTilelinkÁöÑAPLICÊ®°ÂùóÔºåÊØè‰∏™Á≥ªÁªüÈúÄË¶Å‰∏Ä‰∏™ÂÆû‰æã</li>
<li><code>TLIMSIC</code>Ôºà@<code>IMSIC.scala</code>ÔºâÔºöÂü∫‰∫éTilelinkÁöÑIMSICÊ®°ÂùóÔºåÊØè‰∏™Â§ÑÁêÜÂô®Ê†∏ÂøÉÈúÄË¶Å‰∏Ä‰∏™ÂÆû‰æã</li>
<li><code>APLICParams</code>Âíå<code>IMSICParams</code>Ôºà@<code>Params.scala</code>ÔºâÔºöÁî®‰∫éÈÖçÁΩÆAPLICÂíåIMSICÂÆû‰æãÁöÑÂèÇÊï∞Á±ª</li>
</ul>
<p>Integration involves 3 scala files and 4 scala classes:</p>
<ul>
<li><code>TLAPLIC</code> (@<code>APLIC.scala</code>): The Tilelink-based APLIC module, requiring one instance per system,</li>
<li><code>TLIMSIC</code> (@<code>IMSIC.scala</code>): The Tilelink-based IMSIC module, requiring one instance per hart,</li>
<li><code>APLICParams</code> and <code>IMSICParams</code> (@<code>Params.scala</code>): Parameter classes for configuring APLIC and IMSIC instances.</li>
</ul>
<p><img src="images/integration_files.svg" alt="" /></p>
<p><strong>Ê≥®ÊÑè</strong>Ôºö<code>TLAPLIC</code>ÈúÄË¶ÅÂêåÊó∂‰ΩøÁî®<code>APLICParams</code>Âíå<code>IMSICParams</code>ÁöÑÂèÇÊï∞Êù•Á°ÆÂÆöMSIÂèëÈÄÅÂú∞ÂùÄÔºåËÄå<code>TLIMSIC</code>Âè™ÈúÄË¶Å<code>IMSICParams</code>ÁöÑÂèÇÊï∞„ÄÇ</p>
<p><strong>Note</strong>: <code>TLAPLIC</code> requires parameters from both <code>APLICParams</code> and <code>IMSICParams</code> to determine MSI sending addresses, while <code>TLIMSIC</code> only needs <code>IMSICParams</code>.</p>
<h2 id="ÂèÇÊï∞parameters"><a class="header" href="#ÂèÇÊï∞parameters">ÂèÇÊï∞ÔºàParametersÔºâ</a></h2>
<p>Êú¨ËäÇÊ¶ÇËø∞‰∫ÜAPLICÂíåIMSICÁöÑÂèØÈÖçÁΩÆÂèÇÊï∞„ÄÇ
ËôΩÁÑ∂Êèê‰æõ‰∫ÜÈªòËÆ§ÂÄºÔºå‰ΩÜÊàë‰ª¨Âº∫ÁÉàÂª∫ËÆÆÊ†πÊçÆÂÖ∑‰ΩìÁöÑÈõÜÊàêÈúÄÊ±ÇÔºåËá™ÂÆö‰πâÂ∏¶ÊúâüëâÊ†áËÆ∞ÁöÑÂèÇÊï∞„ÄÇ
ÂÖ∂‰ªñÂèÇÊï∞Ë¶Å‰πàÊòØÊ¥æÁîüÁöÑÔºåË¶Å‰πàÊòØÁ°¨ÁºñÁ†ÅÁöÑÔºàËØ¶ÊÉÖÂèÇËßÅ<code>Params.scala</code>Ôºâ„ÄÇ</p>
<p>This section outlines the configurable parameters for APLIC and IMSIC.
While defaul values are provided,
we strongly recommend customizing parameters marked with üëâ to suit your specific integration needs.
Other parameters are either derived or hard-coded, (see <code>Params.scala</code> for details).</p>
<p>ÂëΩÂêçÁ∫¶ÂÆöÔºö</p>
<ul>
<li><code>Num</code>ÂêéÁºÄÔºöÊüêÂÆû‰ΩìÁöÑÊï∞ÈáèÔºå</li>
<li><code>Width</code>ÂêéÁºÄÔºöÊüêÂÆû‰ΩìÁöÑ‰ΩçÂÆΩÔºàÈÄöÂ∏∏ÊòØ<code>log2(ÂÆû‰ΩìÊï∞Èáè)</code>ÔºâÔºå</li>
<li><code>Addr</code>ÂêéÁºÄÔºöÊüêÂÆû‰ΩìÁöÑÂú∞ÂùÄ„ÄÇ</li>
</ul>
<p>Naming conventions:</p>
<ul>
<li><code>Num</code> suffix: Number of the items.</li>
<li><code>Width</code> suffix: Bit width of an item (typically <code>log2(number of the item)</code>).</li>
<li><code>Addr</code> suffix: Address of an item.</li>
</ul>
<h3 id="class-imsicparams"><a class="header" href="#class-imsicparams">Class <code>IMSICParams</code></a></h3>
<p>log2(IMSIC‰∏≠Êñ≠Ê∫êÁöÑÊï∞Èáè)
ÈªòËÆ§ÂÄº8Ë°®Á§∫IMSICÊîØÊåÅÊúÄÂ§ö256Ôºà2^8Ôºâ‰∏™‰∏≠Êñ≠Ê∫êÔºö</p>
<p>log2(number of interrupt sources to IMSIC).
The default 8 means IMSIC support at most 256 (2^8) interrupt sources:</p>
<pre><code class="language-scala">  intSrcWidth     : Int  = 8          ,
</code></pre>
<h4 id="‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂèÇÊï∞parameters-for-interrupt-file"><a class="header" href="#‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂèÇÊï∞parameters-for-interrupt-file">‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂèÇÊï∞ÔºàParameters for interrupt fileÔºâ</a></h4>
<p><strong>Ê≥®ÊÑè</strong>Ôºö‰∏≠Êã¨Âè∑ÂÜÖÁöÑÂèòÈáè‰∏éAIAËßÑËåÉ‰∏≠ÁöÑ‰∏ÄËá¥ÔºàÁ¨¨3.6ËäÇÔºöÁî®‰∫éÂ§ö‰∏™‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂÜÖÂ≠òÂå∫ÂüüÊéíÂàóÔºâ„ÄÇ</p>
<p><strong>Note</strong>: The variables in bracket align with the AIA specification (Section 3.6: Memory Region Arrangement for Multiple Interrupt Files).</p>
<p>üëâ ÊØè‰∏™ÁªÑÁöÑÊàêÂëòÊï∞ÈáèÔºàNumber of members per groupÔºâ[\(h_{max}\)]Ôºö</p>
<pre><code class="language-scala">  membersNum      : Int  = 2           ,
</code></pre>
<p>üëâ Êú∫Âô®ÊÄÅ‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂü∫Âú∞ÂùÄÔºàBase address of machine-level interrupt filesÔºâ[\(A\)]Ôºö</p>
<pre><code class="language-scala">  mBaseAddr       : Long = 0x61000000L ,
</code></pre>
<p>üëâ ÁõëÁÆ°ÊÄÅÂíåÂÆ¢Êà∑ÊÄÅ‰∏≠Êñ≠Êñá‰ª∂ÁöÑÂü∫Âú∞ÂùÄÔºàBase addr for supervisor-level and guest-level interrupt files Ôºâ[\(B\)]:</p>
<pre><code class="language-scala">  sgBaseAddr      : Long = 0x82900000L ,
</code></pre>
<p>üëâ ÂÆ¢Êà∑‰∏≠Êñ≠Êñá‰ª∂ÁöÑÊï∞ÈáèÔºàNumber of guest interrupt filesÔºâ:</p>
<pre><code class="language-scala">  geilen          : Int  = 4           ,
</code></pre>
<p>üëâ ÁªÑÁöÑÊï∞ÈáèÔºàNumber of groups Ôºâ[\(g_{max}\)]:</p>
<pre><code class="language-scala">  groupsNum       : Int  = 1           ,
</code></pre>
<h4 id="ÊéßÂà∂Áä∂ÊÄÅÂØÑÂ≠òÂô®ÁöÑÂèÇÊï∞parameters-for-csrs"><a class="header" href="#ÊéßÂà∂Áä∂ÊÄÅÂØÑÂ≠òÂô®ÁöÑÂèÇÊï∞parameters-for-csrs">ÊéßÂà∂Áä∂ÊÄÅÂØÑÂ≠òÂô®ÁöÑÂèÇÊï∞ÔºàParameters for CSRsÔºâ</a></h4>
<p>vgein‰ø°Âè∑ÁöÑ‰ΩçÂÆΩÔºàThe width of the vgein signalÔºâ:</p>
<pre><code class="language-scala">  vgeinWidth      : Int  = 6           ,
</code></pre>
<p>iselect‰ø°Âè∑ÁöÑ‰ΩçÂÆΩ(The width of iselect signal):</p>
<pre><code class="language-scala">  iselectWidth    : Int  = 12          ,
</code></pre>
<h3 id="class-aplicparams"><a class="header" href="#class-aplicparams">Class <code>APLICParams</code></a></h3>
<p>log2(APLICÊé•Êî∂ÁöÑ‰∏≠Êñ≠Ê∫êÊï∞Èáè)„ÄÇ
ÈªòËÆ§ÂÄº7Ë°®Á§∫APLICÊîØÊåÅÊúÄÂ§ö128Ôºà2^7Ôºâ‰∏™‰∏≠Êñ≠Ê∫ê„ÄÇ
<strong>Ê≥®ÊÑè</strong>ÔºöAPLICÁöÑ<code>intSrcWidth</code>ÂøÖÈ°ªÂ∞è‰∫éIMSICÁöÑ<code>intSrcWidth</code>Ôºå
Âõ†‰∏∫APLICÁöÑ‰∏≠Êñ≠Ê∫êÂ∞ÜË¢´ËΩ¨Êç¢‰∏∫MSIÔºå
ËÄåAPLICËΩ¨Êç¢ÊàêÁöÑMSIÊòØIMSIC‰∏≠Êñ≠Ê∫êÁöÑÂ≠êÈõÜ„ÄÇ</p>
<p>log2(number of interrupt sources to APLIC):
The default 7 means APLIC support at most 128 (2^7) interrupt sources.
<strong>Note</strong>: APLIC's <code>intSrcWidth</code> must be <strong>less than</strong> IMSIC's <code>intSrcWidth</code>,
as APLIC interrupt sources are converted to MSIs,
which are a subset of IMSIC's interrupt sources.</p>
<pre><code class="language-scala">  intSrcWidth: Int = 7,
</code></pre>
<p>üëâ APLICÂüüÁöÑÂü∫Âú∞ÂùÄÔºàBase address of APLIC domainsÔºâ:</p>
<pre><code class="language-scala">  baseAddr: Long = 0x19960000L,
</code></pre>
<h2 id="ÂÆû‰æãÂåñinstantiation"><a class="header" href="#ÂÆû‰æãÂåñinstantiation">ÂÆû‰æãÂåñÔºàInstantiationÔºâ</a></h2>
<ul>
<li>
<p><code>APLICParams</code>Âíå<code>IMSICParams</code>Ôºö</p>
<ul>
<li>ÊØè‰∏™Á±ª‰∏Ä‰∏™ÂÆû‰æãÔºå</li>
<li>Ê†πÊçÆ<a href="integration.html#%E5%8F%82%E6%95%B0parameters">ÂèÇÊï∞</a>ÈÉ®ÂàÜÁöÑËØ¥ÊòéÔºåÂÆû‰æãÂåñÂèÇÊï∞„ÄÇ</li>
</ul>
</li>
<li>
<p><code>TLAPLIC</code>Ôºö</p>
<ul>
<li>Âçï‰∏™ÂÆû‰æãÔºå</li>
<li>ÂèÇÊï∞<code>params</code>ÔºöÊé•Êî∂<code>APLICParams</code>ÁöÑÂÆû‰æãÔºå</li>
<li>ÂèÇÊï∞<code>imsic_params</code>ÔºöÊé•Êî∂<code>IMSICParams</code>ÁöÑÂÆû‰æã„ÄÇ</li>
</ul>
</li>
<li>
<p><code>TLIMSIC</code>Ôºö</p>
<ul>
<li>ÊØè‰∏™Ê†∏ÂøÉ‰∏Ä‰∏™ÂÆû‰æãÔºå</li>
<li>ÂèÇÊï∞<code>params</code>ÔºöÊé•Êî∂<code>IMSICParams</code>ÁöÑÂÆû‰æãÔºå</li>
<li>ÂèÇÊï∞<code>hartIndex</code>ÔºöÊé•Êî∂‰∏éÊ≠§IMSICÈÖçÂØπÁöÑÊ†∏ÂøÉÁöÑÁºñÂè∑„ÄÇ</li>
</ul>
</li>
<li>
<p><code>APLICParams</code> and <code>IMSICParams</code>:</p>
<ul>
<li>Single instance each,</li>
<li>Instantiation parameters according to <a href="integration.html#%E5%8F%82%E6%95%B0parameters">Parameters</a> section.</li>
</ul>
</li>
<li>
<p><code>TLAPLIC</code>:</p>
<ul>
<li>Single instance,</li>
<li>Parameter <code>params</code>: receiving the <code>APLICParams</code>'s instance,</li>
<li>Parameters <code>imsic_params</code>: receiving the <code>IMSICParams</code>'s instance.</li>
</ul>
</li>
<li>
<p><code>TLIMSIC</code>:</p>
<ul>
<li>One instance per hart,</li>
<li>Parameter <code>params</code>: receiving the <code>IMSICParams</code>'s instance,</li>
<li>Parameter <code>hartIndex</code>: receiving the index of hart with which this IMSIC paired to.</li>
</ul>
</li>
</ul>
<h3 id="ÂÖ≥‰∫éhartindexabout-hartindex"><a class="header" href="#ÂÖ≥‰∫éhartindexabout-hartindex"><span style="color:red;">ÂÖ≥‰∫éhartIndexÔºàAbout hartIndexÔºâ</span></a></h3>
<p>Ê†πÊçÆAIAËßÑËåÉÔºö
<span style="color:red;">AIAÁöÑhartÁºñÂè∑</span>
ÂèØËÉΩ‰∏éRISC-VÁâπÊùÉÊû∂ÊûÑÂàÜÈÖçÁªôhartÁöÑÂîØ‰∏Ä
<span style="color:red;">hartÊ†áËØÜÁ¨¶Ôºà‚Äúhart ID‚ÄùÔºâÊó†ÂÖ≥</span>„ÄÇ
Âú®ChiselAIA‰∏≠ÔºåhartIndexÁºñÁ†Å‰∏∫groupIDÊãºÊé•‰∏ämemberID„ÄÇ</p>
<p>According to the AIA specification:
The <span style="color:red;">AIA's hart index</span> may or
<span style="color:red;">may not have any relationship to</span> the unique
<span style="color:red;">hart identifier ("hart ID")</span>
that the RISC-V Privileged Architecture assigns to the hart.
In ChiselAIA, the hartIndex is encoded as a concatenation of <code>groupID</code> and <code>memberID</code>:</p>
<p><img src="./images/hart_index.svg" alt="" /></p>
<h2 id="Á§∫‰æãexamples"><a class="header" href="#Á§∫‰æãexamples">Á§∫‰æãÔºàExamplesÔºâ</a></h2>
<h3 id="ÁÆÄÂçïÁöÑ4Ê†∏Á≥ªÁªüa-simple-4-hart-system"><a class="header" href="#ÁÆÄÂçïÁöÑ4Ê†∏Á≥ªÁªüa-simple-4-hart-system">ÁÆÄÂçïÁöÑ4Ê†∏Á≥ªÁªüÔºàA Simple 4-Hart SystemÔºâ</a></h3>
<p>ÂØπ‰∫é‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊú™ÂàÜÁªÑÁ≥ªÁªüÔºåËÆæÁΩÆgroupsNum=1ÔºåÂàôÂèØ‰ª•Â∞Ühart IDÂ§çÁî®‰Ωú‰∏∫AIAÁöÑ`hartIndexÔºö</p>
<p>For a simple ungrouped system, set groupsNum=1 to allow reuse of hart ID as AIA's <code>hartIndex</code>:</p>
<pre><code class="language-scala">val imsic_params = IMSICParams(groupsNum=1, membersNum=4)
val aplic_params = APLICParams()
val imsics = (0 until 4).map( i =&gt; {
  val imsic = LazyModule(new TLIMSIC(imsic_params, i)(Parameters.empty))
val aplic = LazyModule(new TLAPLIC(aplic_params, imsic_params)(Parameters.empty))
</code></pre>
<h3 id="ÂàÜÁªÑÁöÑ4Ê†∏Á≥ªÁªüa-grouped-4-hart-system"><a class="header" href="#ÂàÜÁªÑÁöÑ4Ê†∏Á≥ªÁªüa-grouped-4-hart-system">ÂàÜÁªÑÁöÑ4Ê†∏Á≥ªÁªüÔºàA Grouped 4-Hart SystemÔºâ</a></h3>
<p>‰∏∫‰∫ÜÂçïÂÖÉÊµãËØïÔºåÂú®<code>src/main/scala/ChiselAIA.scala</code>‰∏≠ÔºåÊàë‰ª¨ÂÆû‰æãÂåñ‰∫Ü‰∏Ä‰∏™ÊØèÁªÑ2‰∏™ÊàêÂëòÁöÑ2ÁªÑÁ≥ªÁªüÔºö</p>
<p>In <code>src/main/scala/ChiselAIA.scala</code>, for unit tests, we instantiate a 2-group 2-member-per-group system:</p>
<pre><code class="language-scala">val imsic_params = IMSICParams(groupsNum=2, membersNum=2)
val aplic_params = APLICParams()
val imsics = (0 until 4).map( i =&gt; {
  val imsic = LazyModule(new TLIMSIC(imsic_params, i)(Parameters.empty))
val aplic = LazyModule(new TLAPLIC(aplic_params, imsic_params)(Parameters.empty))
</code></pre>
<p>Ê≠§ÈÖçÁΩÆÂàõÂª∫‰∫Ü‰∏Ä‰∏™2‰ΩçÁöÑ<code>hartIndex</code>ÔºåÈ´ò‰ΩçË°®Á§∫ groupIDÔºå‰Ωé‰ΩçË°®Á§∫ memberID„ÄÇ
ÊúâÂÖ≥ËØ¶ÁªÜÁöÑIOËøûÊé•ÔºåËØ∑ÂèÇËÄÉ<code>src/main/scala/ChiselAIA.scala</code>„ÄÇ</p>
<p>This configuration creates a 2-bit <code>hartIndex</code> where the higher bit represents <code>groupID</code> and the lower bit represents <code>memberID</code>.
For detailed IO connections, refer to <code>src/main/scala/ChiselAIA.scala</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>

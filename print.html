<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ChiselAIA</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">ChiselAIA</li><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> ğŸ˜ºAIA</a></li><li class="chapter-item expanded "><a href="imsic.html"><strong aria-hidden="true">2.</strong> ğŸ“©IMSIC</a></li><li class="chapter-item expanded "><a href="aplic.html"><strong aria-hidden="true">3.</strong> ğŸ§¶APLIC</a></li><li class="chapter-item expanded "><a href="integration.html"><strong aria-hidden="true">4.</strong> ğŸ§­é›†æˆæŒ‡å—ï¼ˆIntegration Guideï¼‰</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ChiselAIA</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/OpenXiangShan-Nanhu/ChiselAIA" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="chiselaia"><a class="header" href="#chiselaia">ğŸ˜ºChiselAIA</a></h1>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="index.html#%E7%AE%80%E4%BB%8Bintroduction">ç®€ä»‹ï¼ˆIntroductionï¼‰</a></li>
<li><a href="index.html#%E4%B8%AD%E6%96%AD%E9%80%9A%E8%B7%AFinterrupt-paths">ä¸­æ–­é€šè·¯ï¼ˆInterrupt Pathsï¼‰</a></li>
<li><a href="index.html#%E9%85%8D%E7%BD%AE%E9%80%9A%E8%B7%AFconfiguration-paths">é…ç½®é€šè·¯ï¼ˆConfiguration Pathsï¼‰</a></li>
<li><a href="index.html#%E5%BC%95%E7%94%A8references">å¼•ç”¨ï¼ˆReferencesï¼‰</a></li>
</ul>
<!-- vim-markdown-toc -->
<p>ChiselAIAçš„å®ç°éµå¾ª<a href="https://github.com/riscv/riscv-aia">RISC-Vé«˜çº§ä¸­æ–­æ¶æ„ï¼ˆAdvanced Interrupt Architecture, AIAï¼‰è§„èŒƒ</a>ã€‚
å®ç°ä¸è§„èŒƒä¹‹é—´çš„ä»»ä½•å·®å¼‚éƒ½åº”è§†ä¸ºå®ç°bugã€‚</p>
<p>The implementation of ChiselAIA adheres to the <a href="https://github.com/riscv/riscv-aia">RISC-V Advanced Interrupt Architecture (AIA) Specification</a>.
Any discrepancies between the implementation and specification should be treated as implementation bugs.</p>
<h2 id="ç®€ä»‹introduction"><a class="header" href="#ç®€ä»‹introduction">ç®€ä»‹ï¼ˆIntroductionï¼‰</a></h2>
<p>AIAæ—¨åœ¨é«˜æ•ˆåœ°å°†å¤–éƒ¨ä¸­æ–­è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†å™¨æ ¸å¿ƒï¼ˆhartï¼‰å’Œç‰¹æƒæ€ã€‚
è¿™ç§è·¯ç”±é€šè¿‡ä¸¤ä¸ªä¸­æ–­æ§åˆ¶å™¨æ¥å®Œæˆï¼š</p>
<p>AIA is designed to efficiently route external interrupts to the appropriate harts and privilege levels.
This routing is accomplished by two interrupt controllers:</p>
<ul>
<li>Incoming Message-Signaled Interrupt Controller (<strong>IMSIC</strong>)</li>
<li>Advanced Platform-Level Interrupt Controller (<strong>APLIC</strong>)</li>
</ul>
<p>ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ç§æ§åˆ¶å™¨ï¼Ÿ
å› ä¸ºå­˜åœ¨ä¸¤ç±»å¤–éƒ¨è®¾å¤‡ï¼š</p>
<ol>
<li><strong>çº¿è®¾å¤‡</strong>ï¼š
é€šè¿‡ä¸“ç”¨çš„ç”µä¿¡å·ï¼ˆè¾¹æ²¿æˆ–ç”µå¹³ï¼‰ä¼ è¾“ä¸­æ–­ã€‚
å®ƒçš„ç‰¹ç‚¹æ˜¯å®ç°ç®€å•ï¼Œå¯æ‰©å±•æ€§å·®ã€‚
å› ä¸ºæ¯ä¸ªä¸­æ–­éƒ½æ„å‘³ç€ä¸€æ ¹è¿æ¥åˆ°å¤„ç†å™¨æ ¸å¿ƒçš„ç‰©ç†çº¿ã€‚</li>
<li><strong>æ¶ˆæ¯ä¿¡å·ä¸­æ–­(Message-signaled-interrupt, MSI)è®¾å¤‡</strong>ï¼š
ä¸­æ–­è¢«ç¼–ç ä¸ºæ¶ˆæ¯ï¼Œå¹¶é€šè¿‡æ€»çº¿/ç½‘ç»œä¼ è¾“ã€‚
å› ä¸ºæ¯ä¸ªä¸­æ–­ä¸éœ€è¦ä¸“ç”¨çš„ç‰©ç†è¿çº¿ï¼Œå› æ­¤MSIä¸çº¿ä¸­æ–­ç›¸æ¯”ï¼Œæœ‰æ›´å¥½çš„å¯æ‰©å±•æ€§ã€‚</li>
</ol>
<p>Why two types of controllers?
There are two types of external devices:</p>
<ol>
<li><strong>Wired devices</strong>:
Interrupts are transmitted via dedicated electronic signals (edge or level),
which is simple to implement but faces scalability challenges,
as each interrupt requires an physical wire connected to the hart.</li>
<li><strong>Message-signaled-interrupt (MSI) devices</strong>:
Interrupts are encoded as messages and transmitted over bus/network,
which offers better scalability compared to wired interrupts,
as no dedicated physical wires needed for each interrupt.</li>
</ol>
<p>åœ¨ RISC-V AIA ä¸­ï¼š</p>
<ul>
<li><strong>APLIC</strong>è´Ÿè´£å¤„ç†çº¿å¤–éƒ¨ä¸­æ–­ã€‚
<strong>æ³¨æ„</strong>ï¼šAPLICå¯ä»¥åœ¨ä¸¤ç§æ¨¡å¼ä¸‹è¿è¡Œ(domaincfg.DM)ï¼š
<ul>
<li><strong>ç›´æ¥é€’é€æ¨¡å¼</strong>ï¼šAPLICç›´æ¥å°†çº¿ä¸­æ–­è·¯ç”±åˆ°å¤„ç†å™¨æ ¸å¿ƒï¼Œæ— éœ€IMSICå‚ä¸ã€‚</li>
<li>MSIé€’é€æ¨¡å¼ï¼šAPLICå°†çº¿ä¸­æ–­è½¬æ¢ä¸ºMSIå¹¶è½¬å‘ç»™IMSICã€‚</li>
<li>ç”±äºMSIæ›´å…·æ‰©å±•æ€§ï¼Œåç»­è®¨è®ºé»˜è®¤APLICé‡‡ç”¨MSIé€’é€æ¨¡å¼ã€‚</li>
</ul>
</li>
<li><strong>IMSIC</strong>è´Ÿè´£å¤„ç†MSIã€‚</li>
</ul>
<p>In RISC-V AIA:</p>
<ul>
<li><strong>APLIC</strong> handles wired external interrupts.
<strong>Note</strong>: APLIC can operate in two modes (<code>domaincfg.DM</code>):
<ul>
<li><strong>Direct delivery mode</strong>: APLIC directly routes wired interrupts to harts without IMSIC involvement.</li>
<li><strong>MSI delivery mode</strong>: APLIC converts wired interrupts into MSIs and forwards them to IMSIC.</li>
<li>Since MSIs represent the more scalable approach, our subsequent discussion assumes the APLIC working in MSI delivery mode.</li>
</ul>
</li>
<li><strong>IMSIC</strong> handles MSIs.</li>
</ul>
<p>è®¾å¤‡ã€ä¸­æ–­æ§åˆ¶å™¨å’Œå¤„ç†å™¨æ ¸å¿ƒä¹‹é—´çš„äº¤äº’ä¸»è¦æ¶‰åŠä¸¤ç§æ•°æ®é€šè·¯ï¼š
<strong>ä¸­æ–­é€šè·¯</strong>å’Œ<strong>é…ç½®é€šè·¯</strong>ï¼Œå¦‚ä¸‹é¢ä¸¤å¼ å›¾æ‰€ç¤ºã€‚</p>
<p>The interaction between devices, interrupt controllers, and harts involves two main types of data paths:
<strong>interrupt paths</strong> and <strong>configuration paths</strong>, shown as the following two figures.</p>
<h2 id="ä¸­æ–­é€šè·¯interrupt-paths"><a class="header" href="#ä¸­æ–­é€šè·¯interrupt-paths">ä¸­æ–­é€šè·¯ï¼ˆInterrupt Pathsï¼‰</a></h2>
<p>å¤–éƒ¨ä¸­æ–­ä¸»è¦æºè‡ªå¤–éƒ¨è®¾å¤‡ï¼Œ
å°½ç®¡åœ¨é«˜çº§ä½¿ç”¨åœºæ™¯ä¸­ï¼Œå†…éƒ¨è®¾å¤‡å’Œå¤„ç†å™¨æ ¸å¿ƒä¹Ÿå¯ä»¥ç”Ÿæˆâ€œå¤–éƒ¨â€ä¸­æ–­
ï¼ˆä¾‹å¦‚å½“ç›‘ç®¡æ€å‘è™šæ‹ŸåŒ–ç›‘ç®¡æ€æ³¨å…¥å¤–éƒ¨ä¸­æ–­æ—¶ï¼‰ã€‚
æ¥ä¸‹æ¥çš„è®¨è®ºé‡ç‚¹å…³æ³¨å¤–éƒ¨è®¾å¤‡ç”Ÿæˆä¸­æ–­å¹¶é€šè¿‡æ§åˆ¶å™¨è·¯ç”±åˆ°å¤„ç†å™¨æ ¸å¿ƒçš„å…¸å‹æƒ…å†µã€‚</p>
<p>External interrupts primarily originate from external devices,
though in advanced scenarios, internal devices and harts can also generate "external" interrupts
(e.g. when supervisor level injects external interrupts into virtualized supervisor level).
The following discussion focuses on the typical case where external devices generate interrupts that are routed through controllers to harts.</p>
<p><img src="./images/arch_interrupt_py.svg" alt="" /></p>
<p>è¯¦ç»†çš„ä¸­æ–­é€šè·¯å¦‚ä¸‹ï¼ˆæ³¨ï¼šåœ¨è¯­è¨€æ¸…æ™°å‰æä¸‹ï¼Œæˆ‘ä»¬å°†çœç•¥â€œå¤–éƒ¨â€ï¼‰ï¼š</p>
<ul>
<li>ä¸­æ–­æ¥æºäºçº¿è®¾å¤‡æˆ–MSIè®¾å¤‡ï¼š
<ul>
<li>çº¿è®¾å¤‡é€šè·¯ï¼š
<ul>
<li>ä¸­æ–­è¢«è½¬å‘åˆ°APLICçš„<strong>ä¸­æ–­åŸŸ</strong>ã€‚</li>
<li>æ¯ä¸ªåŸŸè´Ÿè´£ç®¡ç†æŸä¸€ç‰¹æƒæ€çš„ä¸€ç»„å¤„ç†å™¨æ ¸å¿ƒçš„ä¸­æ–­ã€‚</li>
<li>å¯¹äºå¤§å‹å¯¹ç§°å¤šå¤„ç†ç³»ç»Ÿï¼Œé€šå¸¸ä¸¤ä¸ªåŸŸå°±è¶³å¤Ÿäº†<sup class="footnote-reference"><a href="#two_interrupt_domains">1</a></sup>ï¼š
<ul>
<li>ä¸€ä¸ª<strong>æœºå™¨æ€åŸŸ</strong>ï¼Œ</li>
<li>ä¸€ä¸ª<strong>ç›‘ç®¡æ€åŸŸ</strong>ã€‚</li>
</ul>
</li>
<li>åŸŸéµå¾ªå±‚çº§ç»“æ„ï¼š
<ul>
<li>æ‰€çº¿ä¸­æ–­é¦–å…ˆåˆ°è¾¾æœºå™¨æ€åŸŸã€‚</li>
<li>æ ¹æ®APLICçš„é…ç½®ï¼Œæ¯ä¸ªä¸­æ–­å¯ä»¥ï¼š
<ul>
<li>è½¬æ¢ä¸ºMSIå¹¶é€šè¿‡æ€»çº¿/ç½‘ç»œè½¬å‘ç»™IMSICï¼Œ</li>
<li>å§”æ‰˜ç»™å­åŸŸï¼Œç„¶åéµå¾ªç±»ä¼¼çš„å¤„ç†æµç¨‹ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>MSIè®¾å¤‡é€šè·¯ï¼š
<ul>
<li>MSIé€šè¿‡æ€»çº¿/ç½‘ç»œç›´æ¥è·¯ç”±åˆ°IMSICã€‚</li>
</ul>
</li>
</ul>
</li>
<li>IMSICå¤„ç†æµç¨‹ï¼š
<ul>
<li>æ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒé€šå¸¸æœ‰å…¶ä¸“ç”¨çš„IMSICã€‚</li>
<li>æ¯ä¸ªIMSICåŒ…å«å¤šä¸ªä¸­æ–­æ–‡ä»¶ï¼Œæ¯ä¸ªç‰¹æƒæ€å¯¹åº”ä¸€ä¸ª<strong>ä¸­æ–­æ–‡ä»¶</strong><sup class="footnote-reference"><a href="#one_imsic_per_hart">2</a></sup>ï¼š
<ul>
<li>ä¸€ä¸ª<strong>æœºå™¨æ€</strong>ï¼Œ</li>
<li>ä¸€ä¸ª<strong>ç›‘ç®¡æ€</strong>ï¼Œ</li>
<li>å¤šä¸ª<strong>è™šæ‹ŸåŒ–ç›‘ç®¡æ€</strong>ã€‚</li>
</ul>
</li>
<li>æ¯ä¸ªä¸­æ–­æ–‡ä»¶ï¼š
<ul>
<li>ç»´æŠ¤ä¸­æ–­çŠ¶æ€(å¾…å¤„ç†ã€ä½¿èƒ½ç­‰)ï¼Œ</li>
<li>æ ¹æ®é…ç½®é€šè¿‡çº¿è·¯å‘å¤„ç†å™¨æ ¸å¿ƒå‘å‡ºä¸­æ–­ä¿¡å·ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Here are the detailed interrupts paths (note: "external" is omitted where context is clear):</p>
<ul>
<li>Interrupts originate from either wired devices or MSI devices:
<ul>
<li>Wired device paths:
<ul>
<li>Interrupts are directed to APLIC's <strong>interrupt domains</strong>.</li>
<li>Each domain manages interrupts for a specific set of harts at a given privilege level.</li>
<li>For large symmetric multiprocessing systems, typically two domains suffice<sup class="footnote-reference"><a href="#two_interrupt_domains">1</a></sup>:
<ul>
<li>One <strong>machine-level domain</strong>,</li>
<li>One <strong>supervisor-level domain</strong>.</li>
</ul>
</li>
<li>Domains follow a hierarchical structure:
<ul>
<li>All wired interrupts fist arrive at the machine-level domain.</li>
<li>Based on APLIC configuration, each interrup is either:
<ul>
<li>Converted to MSI and forwarded to IMSIC via bus/network,</li>
<li>Delegated to child domains, which then follow similar processing.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>MSI device paths:
<ul>
<li>MSIs route directly to IMSIC via bus/network.</li>
</ul>
</li>
</ul>
</li>
<li>IMSIC processing:
<ul>
<li>Each hart typically has its dedicated IMSIC.</li>
<li>Each IMSIC contains multiple <strong>interrupt files</strong>, one per privilege level<sup class="footnote-reference"><a href="#one_imsic_per_hart">2</a></sup>:
<ul>
<li>One <strong>machine level</strong>,</li>
<li>One <strong>supervisor level</strong>,</li>
<li>Multiple <strong>virtualized supervisor levels</strong>.</li>
</ul>
</li>
<li>Each interrupt file:
<ul>
<li>Maintains interrup status (pending, enabled, ...),</li>
<li>Signals hart based on configuration via wire connection.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="é…ç½®é€šè·¯configuration-paths"><a class="header" href="#é…ç½®é€šè·¯configuration-paths">é…ç½®é€šè·¯ï¼ˆConfiguration Pathsï¼‰</a></h2>
<p>é…ç½®æµç¨‹éµå¾ªä¸¤ä¸ªä¸åŒçš„é€šè·¯ï¼š</p>
<ul>
<li>IMSICé…ç½®ï¼š
<ul>
<li>æ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒåªé…ç½®å…¶ä¸“ç”¨çš„IMSICï¼Œ</li>
<li>é…ç½®é€šè¿‡çº¿è·¯è¿æ¥è¿›è¡Œã€‚</li>
</ul>
</li>
<li>APLICé…ç½®ï¼š
<ul>
<li>æ‰€æœ‰å¤„ç†å™¨æ ¸å¿ƒéƒ½å¯ä»¥é…ç½®APLICï¼Œ</li>
<li>é…ç½®ä»¥æ¶ˆæ¯å½¢å¼é€šè¿‡æ€»çº¿ä¼ è¾“ã€‚</li>
</ul>
</li>
</ul>
<p>Configuration flow follows two distinct paths:</p>
<ul>
<li>IMSIC configuration:
<ul>
<li>Each hart configures only its dedicated IMSIC,</li>
<li>Configuration occurs through direct wire connection.</li>
</ul>
</li>
<li>APLIC Configuration:
<ul>
<li>All harts can configure APLIC,</li>
<li>Configuration transmitted via bus as messages.</li>
</ul>
</li>
</ul>
<p><img src="./images/arch_configure_py.svg" alt="" /></p>
<h2 id="å¼•ç”¨references"><a class="header" href="#å¼•ç”¨references">å¼•ç”¨ï¼ˆReferencesï¼‰</a></h2>
<ul>
<li>
<div class="footnote-definition" id="two_interrupt_domains"><sup class="footnote-definition-label">1</sup>
<p><em>The RISC-V Advanced Interrupt Architecture</em>: 4.2 Interrupt domains: Figure 4.</p>
</div>
</li>
<li>
<div class="footnote-definition" id="one_imsic_per_hart"><sup class="footnote-definition-label">2</sup>
<p><em>The RISC-V Advanced Interrupt Architecture</em>: 1.3.2. External interrupts with IMSICs.</p>
</div>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="imsic"><a class="header" href="#imsic">ğŸ“©IMSIC</a></h1>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="imsic.html#%E5%8D%95%E4%B8%AAimsic%E7%9A%84%E5%8A%9F%E8%83%BDindividual-imsic-functionality">å•ä¸ªIMSICçš„åŠŸèƒ½ï¼ˆIndividual IMSIC Functionalityï¼‰</a>
<ul>
<li><a href="imsic.html#imsic%E7%9A%84%E8%BE%93%E5%85%A5%E4%B8%8E%E8%BE%93%E5%87%BAimsic-io">IMSICçš„è¾“å…¥ä¸è¾“å‡ºï¼ˆIMSIC IOï¼‰</a></li>
<li><a href="imsic.html#%E4%B8%AD%E6%96%AD%E6%96%87%E4%BB%B6%E7%9A%84%E8%BE%93%E5%85%A5%E4%B8%8E%E8%BE%93%E5%87%BAinterrupt-file-io">ä¸­æ–­æ–‡ä»¶çš„è¾“å…¥ä¸è¾“å‡ºï¼ˆInterrupt File IOï¼‰</a></li>
<li><a href="imsic.html#%E4%B8%AD%E6%96%AD%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E5%AF%84%E5%AD%98%E5%99%A8interrupt-file-memory-mapped-registers">ä¸­æ–­æ–‡ä»¶çš„å†…å­˜æ˜ å°„å¯„å­˜å™¨ï¼ˆInterrupt File Memory-mapped Registersï¼‰</a></li>
<li><a href="imsic.html#%E4%B8%AD%E6%96%AD%E6%96%87%E4%BB%B6%E5%86%85%E9%83%A8%E7%9A%84%E5%AF%84%E5%AD%98%E5%99%A8interrupt-file-internal-registers">ä¸­æ–­æ–‡ä»¶å†…éƒ¨çš„å¯„å­˜å™¨ï¼ˆInterrupt File Internal Registersï¼‰</a></li>
</ul>
</li>
<li><a href="imsic.html#%E5%A4%9A%E4%B8%AAimsic%E7%9A%84%E7%BB%84%E7%BB%87%E5%BD%A2%E5%BC%8Fmultiple-imsics-arrangement">å¤šä¸ªIMSICçš„ç»„ç»‡å½¢å¼ï¼ˆMultiple IMSICs Arrangementï¼‰</a>
<ul>
<li><a href="imsic.html#imsic%E5%9C%B0%E5%9D%80%E5%AD%97%E6%AE%B5imsic-address-fields">IMSICåœ°å€å­—æ®µï¼ˆIMSIC Address Fieldsï¼‰</a></li>
<li><a href="imsic.html#imsic%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9Fimsic-memory-regions">IMSICå†…å­˜åŒºåŸŸï¼ˆIMSIC Memory Regionsï¼‰</a></li>
</ul>
</li>
</ul>
<!-- vim-markdown-toc -->
<p>åœ¨å…¸å‹çš„RISC-Vç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒéƒ½é…æœ‰ä¸“ç”¨çš„IMSICã€‚
IMSICæ‰§è¡Œä¸‰ä¸ªä¸»è¦åŠŸèƒ½:</p>
<ul>
<li>é€šè¿‡å†…å­˜æ˜ å°„å¯„å­˜å™¨æ¥æ”¶MSIï¼Œ</li>
<li>ä¸ºå…¶å…³è”çš„å¤„ç†å™¨æ ¸å¿ƒç”Ÿæˆä¸­æ–­ï¼Œ</li>
<li>ç®¡ç†å¤„ç†å™¨æ ¸å¿ƒæ‰€éœ€çš„AIAæ§åˆ¶å¯„å­˜å™¨ã€‚</li>
</ul>
<p>In a typical RISC-V system, each hart is paired with its dedicated IMSIC.
The IMSIC performs three main functions:</p>
<ul>
<li>Receives MSIs through memory-mapped registers,</li>
<li>Generates interrupts for its associated hart,</li>
<li>Manages AIA CSRs under hart control.</li>
</ul>
<p>åœ¨å¯¹ç§°å¤šå¤„ç†ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªâ€œæ ¸-IMSICâ€å¯¹å¯ä»¥åˆ’åˆ†æˆç»„ï¼Œ
æ¯ç»„åŒ…å«ç›¸åŒæ•°é‡çš„æ ¸-IMSICå¯¹ã€‚</p>
<p>In symmetric multiprocessing systems, multiple harts-IMSIC pairs can be organized into groups,
with each group containing an equal number of pairs.</p>
<h2 id="å•ä¸ªimsicçš„åŠŸèƒ½individual-imsic-functionality"><a class="header" href="#å•ä¸ªimsicçš„åŠŸèƒ½individual-imsic-functionality">å•ä¸ªIMSICçš„åŠŸèƒ½ï¼ˆIndividual IMSIC Functionalityï¼‰</a></h2>
<h3 id="imsicçš„è¾“å…¥ä¸è¾“å‡ºimsic-io"><a class="header" href="#imsicçš„è¾“å…¥ä¸è¾“å‡ºimsic-io">IMSICçš„è¾“å…¥ä¸è¾“å‡ºï¼ˆIMSIC IOï¼‰</a></h3>
<p>IMSICä¸å…¶å¤„ç†å™¨æ ¸å¿ƒç´§å¯†è€¦åˆï¼Œ
ç›´æ¥ä½¿ç”¨çº¿è·¯è¿æ¥è€Œä¸æ˜¯æ€»çº¿/ç½‘ç»œè¿›è¡Œä¿¡æ¯ä¼ è¾“ã€‚
å…¶å…³é”®ä¿¡å·åŒ…æ‹¬:</p>
<ul>
<li><code>pendings</code>: æ¯ä¸ªä¸­æ–­æ–‡ä»¶çš„å¾…å¤„ç†ä¸­æ–­çŠ¶æ€ã€‚</li>
<li><code>{m,s,vs}topei</code>: æ¯ä¸ªç‰¹æƒæ€ä¸­ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„å¤–éƒ¨ä¸­æ–­å·ã€‚</li>
<li><code>{m.s,vs}iselect</code>: æ¯ä¸ªç‰¹æƒæ€ä¸­ï¼Œé—´æ¥è®¿é—®æ§åˆ¶å¯„å­˜å™¨çš„åœ°å€ã€‚</li>
<li><code>{m,s,vs}ireg</code>: æ¯ä¸ªç‰¹æƒæ€ä¸­ï¼Œé—´æ¥è®¿é—®æ§åˆ¶å¯„å­˜å™¨æ‰€è¯»å†™çš„æ•°æ®ã€‚</li>
<li><code>vgein</code>: è™šæ‹ŸåŒ–ç›‘ç®¡æ€çš„é€‰æ‹©ä¿¡å·ã€‚</li>
</ul>
<p>The IMSIC is tightly coupled with its hart,
directly using wire connection rather than bus/network for information transfer.
Key signals include:</p>
<ul>
<li><code>pendings</code>: Pending interrupt status for each interrupt file.</li>
<li><code>{m,s,vs}topei</code>: Top external interrupt ID for each privilege level.</li>
<li><code>{m.s,vs}iselect</code>: CSR indirect access address for each privilege level.</li>
<li><code>{m,s,vs}ireg</code>: Read and write data for indirect CSR access for each privilege level.</li>
<li><code>vgein</code>: Virtualized supervisor level selector.</li>
</ul>
<p><img src="./images/imsic_py.svg" alt="" /></p>
<h3 id="ä¸­æ–­æ–‡ä»¶çš„è¾“å…¥ä¸è¾“å‡ºinterrupt-file-io"><a class="header" href="#ä¸­æ–­æ–‡ä»¶çš„è¾“å…¥ä¸è¾“å‡ºinterrupt-file-io">ä¸­æ–­æ–‡ä»¶çš„è¾“å…¥ä¸è¾“å‡ºï¼ˆInterrupt File IOï¼‰</a></h3>
<p>ä¸€ä¸ªIMSICè´Ÿè´£ç®¡ç†å…¶å¤„ç†å™¨æ ¸å¿ƒä¸­çš„æ‰€æœ‰ç‰¹æƒæ€ï¼Œ
åŒ…æ‹¬ï¼šä¸€ä¸ªæœºå™¨æ€ã€ä¸€ä¸ªç›‘ç®¡æ€å’Œå¤šä¸ªè™šæ‹ŸåŒ–ç›‘ç®¡æ€ã€‚
ç”±äºæ¯ä¸ªæ€çš„è¡Œä¸ºåœ¨ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ç›¸åŒçš„ï¼ŒAIAè§„èŒƒå°†è¿™äº›åŠŸèƒ½æ¨¡å—åŒ–æˆç‹¬ç«‹ä¸”å¯é‡ç”¨çš„ç»„ä»¶ï¼Œç§°ä¸ºä¸­æ–­æ–‡ä»¶ã€‚
æ¯ä¸ªä¸­æ–­æ–‡ä»¶ä¸IMSICäº¤æ¢ä¸ç‰¹æƒæ€æ— å…³çš„ä¿¡æ¯:</p>
<ul>
<li><code>pending</code>: è¯¥ä¸­æ–­æ–‡ä»¶çš„ä¸­æ–­çŠ¶æ€ã€‚</li>
<li><code>topei</code>: è¯¥ä¸­æ–­æ–‡ä»¶ä¸­ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„å¤–éƒ¨ä¸­æ–­å·ã€‚</li>
<li><code>iselect</code>: è¯¥ä¸­æ–­æ–‡ä»¶ä¸­ï¼Œé—´æ¥è®¿é—®æ§åˆ¶å¯„å­˜å™¨çš„åœ°å€ã€‚</li>
<li><code>ireg</code>: è¯¥ä¸­æ–­æ–‡ä»¶ä¸­ï¼Œé—´æ¥è®¿é—®æ§åˆ¶å¯„å­˜å™¨æ‰€è¯»å†™çš„æ•°æ®ã€‚</li>
</ul>
<p>One IMSIC manages all privilege levels in its hart,
including: one machine level, one supervisor level, and multiple virtualized supervisor levels.
As the behaviors of each level are identical in general, the AIA specification modularizes these functionalities of each level into independent and reusable components, called interrupt files.
Each interrupt file exchanges privilege-agnostic information with IMSIC:</p>
<ul>
<li><code>pending</code>: Interrupt pending status for this interrupt file.</li>
<li><code>topei</code>: Top external interrupt ID for this interrupt file.</li>
<li><code>iselect</code>: CSR indirect access address for this interrupt file.</li>
<li><code>ireg</code>: Read and write data for indirect CSR access for this interrupt file.</li>
</ul>
<h3 id="ä¸­æ–­æ–‡ä»¶çš„å†…å­˜æ˜ å°„å¯„å­˜å™¨interrupt-file-memory-mapped-registers"><a class="header" href="#ä¸­æ–­æ–‡ä»¶çš„å†…å­˜æ˜ å°„å¯„å­˜å™¨interrupt-file-memory-mapped-registers">ä¸­æ–­æ–‡ä»¶çš„å†…å­˜æ˜ å°„å¯„å­˜å™¨ï¼ˆInterrupt File Memory-mapped Registersï¼‰</a></h3>
<p>æ¯ä¸ªä¸­æ–­æ–‡ä»¶åŒ…å«ä¸€ä¸ª4KBå†…å­˜é¡µï¼Œç”¨äºæ¥æ”¶æ¥è‡ªæ€»çº¿/ç½‘ç»œçš„æ¶ˆæ¯ã€‚
å†…å­˜é¡µå†…ä»…åŒ…å«ä¸€ä¸ª4Bå†…å­˜æ˜ å°„å¯„å­˜å™¨:</p>
<ul>
<li><code>seteipnum</code>: ä½äºåç§»é‡0x0å¤„ï¼Œæ¥æ”¶ä¼ å…¥çš„ä¸­æ–­å·ã€‚</li>
</ul>
<p>Each interrupt file includes a 4KB memory page for receiving messages from bus/network.
The memory page including only one 4B memory-mapped register:</p>
<ul>
<li><code>seteipnum</code>: Located at offset of 0x0, receiving incoming interrupt IDs.</li>
</ul>
<h3 id="ä¸­æ–­æ–‡ä»¶å†…éƒ¨çš„å¯„å­˜å™¨interrupt-file-internal-registers"><a class="header" href="#ä¸­æ–­æ–‡ä»¶å†…éƒ¨çš„å¯„å­˜å™¨interrupt-file-internal-registers">ä¸­æ–­æ–‡ä»¶å†…éƒ¨çš„å¯„å­˜å™¨ï¼ˆInterrupt File Internal Registersï¼‰</a></h3>
<p>æ‰€æœ‰ä¸Šè¿°æ¥å£éƒ½ä¸ä¸­æ–­æ–‡ä»¶çš„å†…éƒ¨å¯„å­˜å™¨äº¤äº’ã€‚
å…³é”®çš„å†…éƒ¨å¯„å­˜å™¨åŒ…æ‹¬:</p>
<ul>
<li><code>eip[intSrcNumä½]</code>: è¡¨ç¤ºè¯¥ä¸­æ–­æ˜¯å¦å¾…å¤„ç†ã€‚</li>
<li><code>eie[intSrcNumä½]</code>: è¡¨ç¤ºè¯¥ä¸­æ–­æ˜¯å¦ä½¿èƒ½ã€‚</li>
</ul>
<p>Each interrupt file maintains internal registers that interact with the interfaces above.
The key internal registers consist of:</p>
<ul>
<li><code>eip[intSrcNum bits]</code>: Whether this interrupt is pending.</li>
<li><code>eie[intSrcNum bits]</code>: Whether this interrupt is enabled.</li>
</ul>
<h2 id="å¤šä¸ªimsicçš„ç»„ç»‡å½¢å¼multiple-imsics-arrangement"><a class="header" href="#å¤šä¸ªimsicçš„ç»„ç»‡å½¢å¼multiple-imsics-arrangement">å¤šä¸ªIMSICçš„ç»„ç»‡å½¢å¼ï¼ˆMultiple IMSICs Arrangementï¼‰</a></h2>
<p>åœ¨å¤§å‹ç³»ç»Ÿä¸­ï¼Œæ ¸-IMSICå¯¹å¯ä»¥åˆ†æˆå¤šç»„ã€‚
ä¸‹å›¾æ˜¾ç¤ºäº†ä¸€ä¸ªå¯¹ç§°çš„4æ ¸-IMSICç³»ç»Ÿã€‚
è¿™4å¯¹è¢«åˆ†ä¸º2<strong>ç»„</strong>ï¼Œæ¯ç»„åŒ…å«2ä¸ª<strong>æˆå‘˜</strong>(hart-IMSICå¯¹)ã€‚</p>
<p>In a large system, hart-IMSIC pairs can be divided into groups.
The below figure shows a symmetric 4-hart-IMSIC system.
These 4 pairs are divided into 2 <strong>groups</strong>, and each group contains 2 <strong>members</strong> (hart-IMSIC pairs).</p>
<p><img src="./images/imsics_arrangement_py.svg" alt="" /></p>
<h3 id="imsicåœ°å€å­—æ®µimsic-address-fields"><a class="header" href="#imsicåœ°å€å­—æ®µimsic-address-fields">IMSICåœ°å€å­—æ®µï¼ˆIMSIC Address Fieldsï¼‰</a></h3>
<p>ä¸ºäº†æ”¯æŒç‰©ç†å†…å­˜ä¿æŠ¤(physical memory protection, PMP)ï¼Œç›¸åŒç‰¹æƒæ€çš„ä¸­æ–­æ–‡ä»¶ä½äºåŒä¸€å†…å­˜åŒºåŸŸ:</p>
<ul>
<li>æœºå™¨æ€å†…å­˜åŒºåŸŸ:
<ul>
<li>æ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒå¯¹åº”ä¸€ä¸ªæœºå™¨æ€ä¸­æ–­æ–‡ä»¶</li>
</ul>
</li>
<li>ç›‘ç®¡æ€å†…å­˜åŒºåŸŸ:
<ul>
<li>æ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒå¯¹åº”ä¸€ä¸ªç›‘ç®¡æ€ä¸­æ–­æ–‡ä»¶,</li>
<li>æ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒå¯¹åº”å¤šä¸ªè™šæ‹ŸåŒ–ç›‘ç®¡æ€ä¸­æ–­æ–‡ä»¶ã€‚</li>
</ul>
</li>
</ul>
<p>To support physical memory protection (PMP), interrupt files of the same privilege level are located in a same memory region:</p>
<ul>
<li>Machine-level memory region:
<ul>
<li>One machine-level interrupt file per hart</li>
</ul>
</li>
<li>Supervisor-level memory region:
<ul>
<li>One supervisor-level interrupt file per hart,</li>
<li>Multiple virtualized supervisor-level interrupt files per hart.</li>
</ul>
</li>
</ul>
<p>å› æ­¤ï¼Œæ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒåœ¨æœºå™¨æ€å†…å­˜åŒºåŸŸåªå ä¸€é¡µï¼Œä½†åœ¨ç›‘ç®¡æ€å†…å­˜åŒºåŸŸå å¤šé¡µï¼Œ
ç”±<strong>å®¢æˆ·å·</strong>ï¼ˆç›‘ç®¡æ€ä¸º0ï¼Œè™šæ‹ŸåŒ–ç›‘ç®¡æ€ä¸º1ã€2ã€3ã€...)ç´¢å¼•ã€‚
éœ€è¦å››ä¸ªå­—æ®µæ¥ç¡®å®šä¸€ä¸ªIMSICçš„å†…å­˜é¡µçš„åœ°å€ï¼š</p>
<ul>
<li>ç‰¹æƒæ€ï¼šæœºå™¨æ€æˆ–ç›‘ç®¡æ€ã€‚</li>
<li>ç»„å·ï¼šè¯¥IMSICæ‰€å±çš„ç»„ã€‚</li>
<li>æˆå‘˜å·ï¼šè¯¥IMSICæ‰€å±çš„æˆå‘˜ã€‚</li>
<li>å®¢æˆ·å·ï¼šç›‘ç®¡æ€æˆ–è™šæ‹ŸåŒ–ç›‘ç®¡æ€ä¹‹ä¸€ã€‚</li>
</ul>
<p>Thus, each hart has only one page in machine-level memory region and multiple pages in supervisor-level memory region,
indexed by a <strong>guest ID</strong> (0 for supervisor-level, 1,2,3,... for virtualized supervisor level).
When determining the memory page address for a given IMSIC, four fields are needed:</p>
<ul>
<li>Privilege Level: Machine level or supervisor level.</li>
<li>Group ID: The group to which this IMSIC belongs.</li>
<li>Member ID: The member to which this IMSIC belongs.</li>
<li>Guest ID: Supervisor level or one of the virtualized supervisor levels.</li>
</ul>
<p><img src="./images/imsic_addr.svg" alt="" /></p>
<p>æœºå™¨æ€ä¸­æ–­æ–‡ä»¶çš„åœ°å€è¡¨è¾¾å¼ä¸ºï¼š</p>
<p>The formal expression for a machine-level interrupt file address:</p>
<p>$$
\begin{align}
mIntFileAddr =
&amp; mBaseAddr \\
&amp; + groupID \times 2^{mGroupStrideWidth} \\
&amp; + memberID \times 2^{mMemberStrideWidth} \\
&amp; + guestID \times 4K
\end{align}
$$</p>
<p>è™šæ‹ŸåŒ–ç›‘ç®¡æ€ä¸­æ–­æ–‡ä»¶çš„åœ°å€è¡¨è¾¾å¼ä¸ºï¼š</p>
<p>The formal expression for a virtualized supervisor-level interrupt file address:</p>
<p>$$
\begin{align}
vsIntFileAddr =
&amp; vsBaseAddr \\
&amp; + groupID \times 2^{vsGroupStrideWidth} \\
&amp; + memberID \times 2^{vsMemberStrideWidth} \\
&amp; + guestID \times 4K
\end{align}
$$</p>
<p>æŒ‰ç…§AIAè§„èŒƒçš„è¦æ±‚ï¼Œ<code>vsGroupStrideWidth</code>ä¸<code>mGroupStrideWidth</code>ç›¸åŒã€‚
æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…AIAè§„èŒƒ<sup class="footnote-reference"><a href="#imsic_memory_region">1</a></sup>ã€‚</p>
<p>As required by the AIA specification, the <code>vsGroupStrideWidth</code> is the same as the <code>mGroupStrideWidth</code>.
For more details, please refer to the AIA specification<sup class="footnote-reference"><a href="#imsic_memory_region">1</a></sup>.</p>
<h3 id="imsicå†…å­˜åŒºåŸŸimsic-memory-regions"><a class="header" href="#imsicå†…å­˜åŒºåŸŸimsic-memory-regions">IMSICå†…å­˜åŒºåŸŸï¼ˆIMSIC Memory Regionsï¼‰</a></h3>
<p>æœºå™¨å’Œç›‘ç®¡æ€çš„å†…å­˜åŒºåŸŸå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p>The memory regions for machine and supervisor levels are shown as below.</p>
<p><img src="./images/imsic_addr_space.svg" alt="" /></p>
<p>è¿™é‡Œå±•ç¤ºä¸€ä¸ªå…·ä½“çš„ä¾‹å­ã€‚
å‡è®¾æœºå™¨æ€å’Œç›‘ç®¡æ€çš„å†…å­˜åŒºåŸŸåŸºåœ°å€åˆ†åˆ«ä¸º<code>0x6100_0000</code>å’Œ<code>0x8290_0000</code>ï¼Œé‚£ä¹ˆæ¯ä¸ªä¸­æ–­æ–‡ä»¶çš„åœ°å€ä¸ºï¼š</p>
<p>Here is a concrete example.
Assuming the base addresses for machine-level and supervisor-level memory regions are <code>0x6100_0000</code> and <code>0x8290_0000</code>, respectively,
the addresses for each interrupt file are:</p>
<ul>
<li>Machine-level interrupt files:
<ul>
<li>IMSIC00: <code>[0x61000000, 0x61000fff]</code></li>
<li>IMSIC01: <code>[0x61001000, 0x61001fff]</code></li>
<li>IMSIC10: <code>[0x61008000, 0x61008fff]</code></li>
<li>IMSIC11: <code>[0x61009000, 0x61009fff]</code></li>
</ul>
</li>
<li>Supervisor-level interrupt files:
<ul>
<li>IMSIC00: <code>[0x82900000, 0x82903fff]</code></li>
<li>IMSIC01: <code>[0x82904000, 0x82907fff]</code></li>
<li>IMSIC10: <code>[0x82908000, 0x8290bfff]</code></li>
<li>IMSIC11: <code>[0x8290c000, 0x8290ffff]</code></li>
</ul>
</li>
</ul>
<div class="footnote-definition" id="imsic_memory_region"><sup class="footnote-definition-label">1</sup>
<p>The RISC-V Advanced Interrupt Architecture: 3.6. Arrangement of the memory regions of multiple interrupt files</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="aplic"><a class="header" href="#aplic">ğŸ§¶APLIC</a></h1>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="aplic.html#%E5%9F%9Fdomain">åŸŸï¼ˆDomainï¼‰</a>
<ul>
<li><a href="aplic.html#%E5%86%85%E9%83%A8%E5%AF%84%E5%AD%98%E5%99%A8internal-registers">å†…éƒ¨å¯„å­˜å™¨ï¼ˆInternal Registersï¼‰</a></li>
</ul>
</li>
</ul>
<!-- vim-markdown-toc -->
<p>åœ¨åŸºäºæ¶ˆæ¯çš„ä¸­æ–­æ¨¡å¼ä¸‹ï¼ŒAPLICå°†ä¼ ç»Ÿçš„çº¿ä¸­æ–­è½¬æ¢ä¸ºMSIã€‚
ä¸ºäº†æé«˜æ•ˆç‡ï¼Œé™¤éè®¾å¤‡åœ¨ç‰©ç†ä¸Šæ˜¯åˆ†å¼€çš„ï¼ˆä¾‹å¦‚åœ¨ä¸åŒçš„èŠ¯ç‰‡ç»„ä¸Šï¼‰ï¼Œå•ä¸ªAPLICå®ä¾‹å³å¯æœåŠ¡æ‰€æœ‰å¤„ç†å™¨æ ¸å¿ƒã€‚</p>
<p>In message-based interrupt mode, the APLIC converts traditional wired interrupts into MSIs.
For efficiency, a single APLIC instance should serve all harts, unless devices are physically separated (e.g. on different chiplets).</p>
<h2 id="åŸŸdomain"><a class="header" href="#åŸŸdomain">åŸŸï¼ˆDomainï¼‰</a></h2>
<p>APLICå®ç°äº†åˆ†å±‚çš„åŸŸç»“æ„æ¥ç®¡ç†ä¸åŒçš„ç‰¹æƒæ€:</p>
<ul>
<li>æ ¹åŸŸï¼ˆæœºå™¨æ€ï¼‰ç›´æ¥æ¥æ”¶æ‰€çº¿ä¸­æ–­,</li>
<li>å­åŸŸä»å…¶çˆ¶åŸŸæ¥æ”¶å§”æ‰˜çš„ä¸­æ–­,</li>
<li>ç›‘ç®¡æ€åŸŸå¯ä»¥å¤„ç†ç›‘ç®¡æ€å’Œè™šæ‹ŸåŒ–ç›‘ç®¡æ€ä¸­æ–­ã€‚</li>
</ul>
<p>The APLIC implements a hierarchical domain structure to manage different privilege levels:</p>
<ul>
<li>The root domain (machine level) directly receives all wired interrupts,</li>
<li>Child domains receive delegated interrupts from their parent domains,</li>
<li>A supervisor-level domain can handle both supervisor-level and virtualized supervisor-level interrupts.</li>
</ul>
<p>å¯¹äºå¤§å‹å¯¹ç§°å¤šå¤„ç†ç³»ç»Ÿï¼Œé€šå¸¸ä¸¤ä¸ªåŸŸçš„é…ç½®å°±è¶³å¤Ÿäº†ï¼š</p>
<ul>
<li>ä¸€ä¸ªæœºå™¨æ€åŸŸ,</li>
<li>ä¸€ä¸ªç›‘ç®¡æ€åŸŸã€‚</li>
</ul>
<p>For large symmetric multiprocessing systems, a two-domain configuration typically suffices:</p>
<ul>
<li>One machine-level domain,</li>
<li>One supervisor-level domain.</li>
</ul>
<p><img src="./images/aplic.svg" alt="" /></p>
<h3 id="å†…éƒ¨å¯„å­˜å™¨internal-registers"><a class="header" href="#å†…éƒ¨å¯„å­˜å™¨internal-registers">å†…éƒ¨å¯„å­˜å™¨ï¼ˆInternal Registersï¼‰</a></h3>
<p>APLICåœ¨å†…éƒ¨å¯„å­˜å™¨ä¸­ç»´æŠ¤ä¸­æ–­çŠ¶æ€ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªå…³é”®å¯„å­˜å™¨ï¼š</p>
<ul>
<li><code>ip[intSrcNumä½]</code>: ä¸­æ–­å¾…å¤„ç†çŠ¶æ€å¯„å­˜å™¨,</li>
<li><code>ie[intSrcNumä½]</code>: ä¸­æ–­ä½¿èƒ½æ§åˆ¶å¯„å­˜å™¨ã€‚</li>
</ul>
<p>APLIC maintains interrupt status in internal registers, including two critical registers:</p>
<ul>
<li><code>ip[intSrcNum bits]</code>: Interrupt pending status registers,</li>
<li><code>ie[intSrcNum bits]</code>: Interrupt enable control registers.</li>
</ul>
<p>è¿™äº›å¯„å­˜å™¨é€šè¿‡å†…å­˜æ˜ å°„æ¥å£è¿›è¡Œæ§åˆ¶ã€‚
æœ‰å…³è¯¦ç»†çš„å¯„å­˜å™¨è§„èŒƒï¼Œè¯·å‚é˜…AIAè§„èŒƒ<sup class="footnote-reference"><a href="#aplic_mem_regs">1</a></sup>ã€‚</p>
<p>These registers are controlled through memory-mapped interfaces.
For detailed register specifications, refer to the AIA specification<sup class="footnote-reference"><a href="#aplic_mem_regs">1</a></sup>.</p>
<p><strong>ç«äº‰æ¡ä»¶</strong>ï¼ˆ<strong>Race Conditions</strong>ï¼‰</p>
<p><code>ip</code>å¯„å­˜å™¨å¯ä»¥è¢«å¤šä¸ªæ¥æºä¿®æ”¹ï¼Œä»è€Œäº§ç”Ÿæ½œåœ¨çš„ç«äº‰æ¡ä»¶ã€‚
AIAè§„èŒƒæ²¡æœ‰è§„å®šAPLICåœ¨è¿™ç§ç«äº‰æ¡ä»¶ä¸‹çš„è¡Œä¸ºã€‚
ChiselAIAå®ç°äº†ä¸€ä¸ªåŸºäºä¼˜å…ˆçº§çš„è§£å†³æœºåˆ¶ã€‚
ä¼˜å…ˆçº§(ä»é«˜åˆ°ä½):</p>
<ul>
<li>APLICå†…éƒ¨æ“ä½œï¼šå‘é€MSIåæ¸…é™¤<code>ip</code>ï¼Œ</li>
<li>çº¿è®¾å¤‡æ“ä½œï¼šé€šè¿‡<code>intSrc</code>è®¾ç½®<code>ip</code>ï¼Œ</li>
<li>å¤„ç†å™¨æ ¸å¿ƒæ“ä½œï¼šé€šè¿‡å†…å­˜æ˜ å°„å¯„å­˜å™¨è®¾ç½®/æ¸…é™¤<code>ip</code>ã€‚</li>
</ul>
<p>The <code>ip</code> registers can be modified by multiple sources, creating potential race conditions.
The AIA specification does not specify the APLIC behaviors under this race condition.
ChiselAIA implements a priority-based resolution mechanism.
Priority levels (highest to lowest):</p>
<ul>
<li>APLIC internal operations: Clearing <code>ip</code> after sending an MSI,</li>
<li>Wired device operations: Setting <code>ip</code> via <code>intSrc</code>,</li>
<li>Hart operations: Setting/Clearing <code>ip</code> via memory mapped registers.</li>
</ul>
<p>é«˜ä¼˜å…ˆçº§æ“ä½œä¼šè¦†ç›–ä½ä¼˜å…ˆçº§æ“ä½œã€‚
æˆ‘ä»¬æ¨èé€šè¿‡ç¼–ç¨‹çš„æ–¹å¼é¿å…ç«äº‰æ¡ä»¶ï¼š
åœ¨é€šè¿‡å†…å­˜æ˜ å°„å¯„å­˜å™¨ä¿®æ”¹ç›¸åº”çš„<code>ip</code>ä¹‹å‰ï¼Œæ–­å¼€çº¿è®¾å¤‡ã€‚</p>
<p>Higher priority operations override the lower priority ones.
We recommend to avoid race conditions through programming:
detaching the wired device before modifying corresponding <code>ip</code> through memory-mapped registers.</p>
<div class="footnote-definition" id="aplic_mem_regs"><sup class="footnote-definition-label">1</sup>
<p>The RISC-V Advanced Interrupt Architecture: 4.5. Memory-mapped control region for an interrupt domain</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é›†æˆæŒ‡å—integration-guide"><a class="header" href="#é›†æˆæŒ‡å—integration-guide">ğŸ§­é›†æˆæŒ‡å—ï¼ˆIntegration Guideï¼‰</a></h1>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="integration.html#%E6%A6%82%E8%A7%88overview">æ¦‚è§ˆï¼ˆOverviewï¼‰</a></li>
<li><a href="integration.html#%E5%8F%82%E6%95%B0parameters">å‚æ•°ï¼ˆParametersï¼‰</a></li>
<li><a href="integration.html#%E5%AE%9E%E4%BE%8B%E5%8C%96instantiation">å®ä¾‹åŒ–ï¼ˆInstantiationï¼‰</a>
<ul>
<li><a href="integration.html#span-stylecolorred%E5%85%B3%E4%BA%8Ehartindexabout-hartindexspan"><span style="color:red;">å…³äºhartIndexï¼ˆAbout hartIndexï¼‰</span></a></li>
</ul>
</li>
<li><a href="integration.html#%E7%A4%BA%E4%BE%8Bexamples">ç¤ºä¾‹ï¼ˆExamplesï¼‰</a>
<ul>
<li><a href="integration.html#%E7%AE%80%E5%8D%95%E7%9A%844%E6%A0%B8%E7%B3%BB%E7%BB%9Fa-simple-4-hart-system">ç®€å•çš„4æ ¸ç³»ç»Ÿï¼ˆA Simple 4-Hart Systemï¼‰</a></li>
<li><a href="integration.html#%E5%88%86%E7%BB%84%E7%9A%844%E6%A0%B8%E7%B3%BB%E7%BB%9Fa-grouped-4-hart-system">åˆ†ç»„çš„4æ ¸ç³»ç»Ÿï¼ˆA Grouped 4-Hart Systemï¼‰</a></li>
</ul>
</li>
</ul>
<!-- vim-markdown-toc -->
<p>æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•å°†ChiselAIAé›†æˆåˆ°RISC-Vç³»ç»Ÿä¸­ã€‚</p>
<p>This guide introduces the integration process of ChiselAIA into a RISC-V system.</p>
<h2 id="æ¦‚è§ˆoverview"><a class="header" href="#æ¦‚è§ˆoverview">æ¦‚è§ˆï¼ˆOverviewï¼‰</a></h2>
<p>é›†æˆæ¶‰åŠ3ä¸ªScalaæ–‡ä»¶å’Œ4ä¸ªScalaç±»ï¼š</p>
<ul>
<li><code>TLAPLIC</code>ï¼ˆ@<code>APLIC.scala</code>ï¼‰ï¼šåŸºäºTilelinkçš„APLICæ¨¡å—ï¼Œæ¯ä¸ªç³»ç»Ÿéœ€è¦ä¸€ä¸ªå®ä¾‹</li>
<li><code>TLIMSIC</code>ï¼ˆ@<code>IMSIC.scala</code>ï¼‰ï¼šåŸºäºTilelinkçš„IMSICæ¨¡å—ï¼Œæ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒéœ€è¦ä¸€ä¸ªå®ä¾‹</li>
<li><code>APLICParams</code>å’Œ<code>IMSICParams</code>ï¼ˆ@<code>Params.scala</code>ï¼‰ï¼šç”¨äºé…ç½®APLICå’ŒIMSICå®ä¾‹çš„å‚æ•°ç±»</li>
</ul>
<p>Integration involves 3 scala files and 4 scala classes:</p>
<ul>
<li><code>TLAPLIC</code> (@<code>APLIC.scala</code>): The Tilelink-based APLIC module, requiring one instance per system,</li>
<li><code>TLIMSIC</code> (@<code>IMSIC.scala</code>): The Tilelink-based IMSIC module, requiring one instance per hart,</li>
<li><code>APLICParams</code> and <code>IMSICParams</code> (@<code>Params.scala</code>): Parameter classes for configuring APLIC and IMSIC instances.</li>
</ul>
<p><img src="images/integration_files.svg" alt="" /></p>
<p><strong>æ³¨æ„</strong>ï¼š<code>TLAPLIC</code>éœ€è¦åŒæ—¶ä½¿ç”¨<code>APLICParams</code>å’Œ<code>IMSICParams</code>çš„å‚æ•°æ¥ç¡®å®šMSIå‘é€åœ°å€ï¼Œè€Œ<code>TLIMSIC</code>åªéœ€è¦<code>IMSICParams</code>çš„å‚æ•°ã€‚</p>
<p><strong>Note</strong>: <code>TLAPLIC</code> requires parameters from both <code>APLICParams</code> and <code>IMSICParams</code> to determine MSI sending addresses, while <code>TLIMSIC</code> only needs <code>IMSICParams</code>.</p>
<h2 id="å‚æ•°parameters"><a class="header" href="#å‚æ•°parameters">å‚æ•°ï¼ˆParametersï¼‰</a></h2>
<p>æœ¬èŠ‚æ¦‚è¿°äº†APLICå’ŒIMSICçš„å¯é…ç½®å‚æ•°ã€‚
è™½ç„¶æä¾›äº†é»˜è®¤å€¼ï¼Œä½†æˆ‘ä»¬å¼ºçƒˆå»ºè®®æ ¹æ®å…·ä½“çš„é›†æˆéœ€æ±‚ï¼Œè‡ªå®šä¹‰å¸¦æœ‰ğŸ‘‰æ ‡è®°çš„å‚æ•°ã€‚
å…¶ä»–å‚æ•°è¦ä¹ˆæ˜¯æ´¾ç”Ÿçš„ï¼Œè¦ä¹ˆæ˜¯ç¡¬ç¼–ç çš„ï¼ˆè¯¦æƒ…å‚è§<code>Params.scala</code>ï¼‰ã€‚</p>
<p>This section outlines the configurable parameters for APLIC and IMSIC.
While defaul values are provided,
we strongly recommend customizing parameters marked with ğŸ‘‰ to suit your specific integration needs.
Other parameters are either derived or hard-coded, (see <code>Params.scala</code> for details).</p>
<p>å‘½åçº¦å®šï¼š</p>
<ul>
<li><code>Num</code>åç¼€ï¼šæŸå®ä½“çš„æ•°é‡ï¼Œ</li>
<li><code>Width</code>åç¼€ï¼šæŸå®ä½“çš„ä½å®½ï¼ˆé€šå¸¸æ˜¯<code>log2(å®ä½“æ•°é‡)</code>ï¼‰ï¼Œ</li>
<li><code>Addr</code>åç¼€ï¼šæŸå®ä½“çš„åœ°å€ã€‚</li>
</ul>
<p>Naming conventions:</p>
<ul>
<li><code>Num</code> suffix: Number of the items.</li>
<li><code>Width</code> suffix: Bit width of an item (typically <code>log2(number of the item)</code>).</li>
<li><code>Addr</code> suffix: Address of an item.</li>
</ul>
<h3 id="class-imsicparams"><a class="header" href="#class-imsicparams">Class <code>IMSICParams</code></a></h3>
<p>log2(IMSICä¸­æ–­æºçš„æ•°é‡)
é»˜è®¤å€¼8è¡¨ç¤ºIMSICæ”¯æŒæœ€å¤š256ï¼ˆ2^8ï¼‰ä¸ªä¸­æ–­æºï¼š</p>
<p>log2(number of interrupt sources to IMSIC).
The default 8 means IMSIC support at most 256 (2^8) interrupt sources:</p>
<pre><code class="language-scala">  intSrcWidth     : Int  = 8          ,
</code></pre>
<h4 id="ä¸­æ–­æ–‡ä»¶çš„å‚æ•°parameters-for-interrupt-file"><a class="header" href="#ä¸­æ–­æ–‡ä»¶çš„å‚æ•°parameters-for-interrupt-file">ä¸­æ–­æ–‡ä»¶çš„å‚æ•°ï¼ˆParameters for interrupt fileï¼‰</a></h4>
<p><strong>æ³¨æ„</strong>ï¼šä¸­æ‹¬å·å†…çš„å˜é‡ä¸AIAè§„èŒƒä¸­çš„ä¸€è‡´ï¼ˆç¬¬3.6èŠ‚ï¼šç”¨äºå¤šä¸ªä¸­æ–­æ–‡ä»¶çš„å†…å­˜åŒºåŸŸæ’åˆ—ï¼‰ã€‚</p>
<p><strong>Note</strong>: The variables in bracket align with the AIA specification (Section 3.6: Memory Region Arrangement for Multiple Interrupt Files).</p>
<p>ğŸ‘‰ æ¯ä¸ªç»„çš„æˆå‘˜æ•°é‡ï¼ˆNumber of members per groupï¼‰[\(h_{max}\)]ï¼š</p>
<pre><code class="language-scala">  membersNum      : Int  = 2           ,
</code></pre>
<p>ğŸ‘‰ æœºå™¨æ€ä¸­æ–­æ–‡ä»¶çš„åŸºåœ°å€ï¼ˆBase address of machine-level interrupt filesï¼‰[\(A\)]ï¼š</p>
<pre><code class="language-scala">  mBaseAddr       : Long = 0x61000000L ,
</code></pre>
<p>ğŸ‘‰ ç›‘ç®¡æ€å’Œå®¢æˆ·æ€ä¸­æ–­æ–‡ä»¶çš„åŸºåœ°å€ï¼ˆBase addr for supervisor-level and guest-level interrupt files ï¼‰[\(B\)]:</p>
<pre><code class="language-scala">  sgBaseAddr      : Long = 0x82900000L ,
</code></pre>
<p>ğŸ‘‰ å®¢æˆ·ä¸­æ–­æ–‡ä»¶çš„æ•°é‡ï¼ˆNumber of guest interrupt filesï¼‰:</p>
<pre><code class="language-scala">  geilen          : Int  = 4           ,
</code></pre>
<p>ğŸ‘‰ ç»„çš„æ•°é‡ï¼ˆNumber of groups ï¼‰[\(g_{max}\)]:</p>
<pre><code class="language-scala">  groupsNum       : Int  = 1           ,
</code></pre>
<h4 id="æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨çš„å‚æ•°parameters-for-csrs"><a class="header" href="#æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨çš„å‚æ•°parameters-for-csrs">æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨çš„å‚æ•°ï¼ˆParameters for CSRsï¼‰</a></h4>
<p>vgeinä¿¡å·çš„ä½å®½ï¼ˆThe width of the vgein signalï¼‰:</p>
<pre><code class="language-scala">  vgeinWidth      : Int  = 6           ,
</code></pre>
<p>iselectä¿¡å·çš„ä½å®½(The width of iselect signal):</p>
<pre><code class="language-scala">  iselectWidth    : Int  = 12          ,
</code></pre>
<h3 id="class-aplicparams"><a class="header" href="#class-aplicparams">Class <code>APLICParams</code></a></h3>
<p>log2(APLICæ¥æ”¶çš„ä¸­æ–­æºæ•°é‡)ã€‚
é»˜è®¤å€¼7è¡¨ç¤ºAPLICæ”¯æŒæœ€å¤š128ï¼ˆ2^7ï¼‰ä¸ªä¸­æ–­æºã€‚
<strong>æ³¨æ„</strong>ï¼šAPLICçš„<code>intSrcWidth</code>å¿…é¡»å°äºIMSICçš„<code>intSrcWidth</code>ï¼Œ
å› ä¸ºAPLICçš„ä¸­æ–­æºå°†è¢«è½¬æ¢ä¸ºMSIï¼Œ
è€ŒAPLICè½¬æ¢æˆçš„MSIæ˜¯IMSICä¸­æ–­æºçš„å­é›†ã€‚</p>
<p>log2(number of interrupt sources to APLIC):
The default 7 means APLIC support at most 128 (2^7) interrupt sources.
<strong>Note</strong>: APLIC's <code>intSrcWidth</code> must be <strong>less than</strong> IMSIC's <code>intSrcWidth</code>,
as APLIC interrupt sources are converted to MSIs,
which are a subset of IMSIC's interrupt sources.</p>
<pre><code class="language-scala">  intSrcWidth: Int = 7,
</code></pre>
<p>ğŸ‘‰ APLICåŸŸçš„åŸºåœ°å€ï¼ˆBase address of APLIC domainsï¼‰:</p>
<pre><code class="language-scala">  baseAddr: Long = 0x19960000L,
</code></pre>
<h2 id="å®ä¾‹åŒ–instantiation"><a class="header" href="#å®ä¾‹åŒ–instantiation">å®ä¾‹åŒ–ï¼ˆInstantiationï¼‰</a></h2>
<ul>
<li>
<p><code>APLICParams</code>å’Œ<code>IMSICParams</code>ï¼š</p>
<ul>
<li>æ¯ä¸ªç±»ä¸€ä¸ªå®ä¾‹ï¼Œ</li>
<li>æ ¹æ®<a href="integration.html#%E5%8F%82%E6%95%B0parameters">å‚æ•°</a>éƒ¨åˆ†çš„è¯´æ˜ï¼Œå®ä¾‹åŒ–å‚æ•°ã€‚</li>
</ul>
</li>
<li>
<p><code>TLAPLIC</code>ï¼š</p>
<ul>
<li>å•ä¸ªå®ä¾‹ï¼Œ</li>
<li>å‚æ•°<code>params</code>ï¼šæ¥æ”¶<code>APLICParams</code>çš„å®ä¾‹ï¼Œ</li>
<li>å‚æ•°<code>imsic_params</code>ï¼šæ¥æ”¶<code>IMSICParams</code>çš„å®ä¾‹ã€‚</li>
</ul>
</li>
<li>
<p><code>TLIMSIC</code>ï¼š</p>
<ul>
<li>æ¯ä¸ªæ ¸å¿ƒä¸€ä¸ªå®ä¾‹ï¼Œ</li>
<li>å‚æ•°<code>params</code>ï¼šæ¥æ”¶<code>IMSICParams</code>çš„å®ä¾‹ï¼Œ</li>
<li>å‚æ•°<code>hartIndex</code>ï¼šæ¥æ”¶ä¸æ­¤IMSICé…å¯¹çš„æ ¸å¿ƒçš„ç¼–å·ã€‚</li>
</ul>
</li>
<li>
<p><code>APLICParams</code> and <code>IMSICParams</code>:</p>
<ul>
<li>Single instance each,</li>
<li>Instantiation parameters according to <a href="integration.html#%E5%8F%82%E6%95%B0parameters">Parameters</a> section.</li>
</ul>
</li>
<li>
<p><code>TLAPLIC</code>:</p>
<ul>
<li>Single instance,</li>
<li>Parameter <code>params</code>: receiving the <code>APLICParams</code>'s instance,</li>
<li>Parameters <code>imsic_params</code>: receiving the <code>IMSICParams</code>'s instance.</li>
</ul>
</li>
<li>
<p><code>TLIMSIC</code>:</p>
<ul>
<li>One instance per hart,</li>
<li>Parameter <code>params</code>: receiving the <code>IMSICParams</code>'s instance,</li>
<li>Parameter <code>hartIndex</code>: receiving the index of hart with which this IMSIC paired to.</li>
</ul>
</li>
</ul>
<h3 id="å…³äºhartindexabout-hartindex"><a class="header" href="#å…³äºhartindexabout-hartindex"><span style="color:red;">å…³äºhartIndexï¼ˆAbout hartIndexï¼‰</span></a></h3>
<p>æ ¹æ®AIAè§„èŒƒï¼š
<span style="color:red;">AIAçš„hartç¼–å·</span>
å¯èƒ½ä¸RISC-Vç‰¹æƒæ¶æ„åˆ†é…ç»™hartçš„å”¯ä¸€
<span style="color:red;">hartæ ‡è¯†ç¬¦ï¼ˆâ€œhart IDâ€ï¼‰æ— å…³</span>ã€‚
åœ¨ChiselAIAä¸­ï¼ŒhartIndexç¼–ç ä¸ºgroupIDæ‹¼æ¥ä¸ŠmemberIDã€‚</p>
<p>According to the AIA specification:
The <span style="color:red;">AIA's hart index</span> may or
<span style="color:red;">may not have any relationship to</span> the unique
<span style="color:red;">hart identifier ("hart ID")</span>
that the RISC-V Privileged Architecture assigns to the hart.
In ChiselAIA, the hartIndex is encoded as a concatenation of <code>groupID</code> and <code>memberID</code>:</p>
<p><img src="./images/hart_index.svg" alt="" /></p>
<h2 id="ç¤ºä¾‹examples"><a class="header" href="#ç¤ºä¾‹examples">ç¤ºä¾‹ï¼ˆExamplesï¼‰</a></h2>
<h3 id="ç®€å•çš„4æ ¸ç³»ç»Ÿa-simple-4-hart-system"><a class="header" href="#ç®€å•çš„4æ ¸ç³»ç»Ÿa-simple-4-hart-system">ç®€å•çš„4æ ¸ç³»ç»Ÿï¼ˆA Simple 4-Hart Systemï¼‰</a></h3>
<p>å¯¹äºä¸€ä¸ªç®€å•çš„æœªåˆ†ç»„ç³»ç»Ÿï¼Œè®¾ç½®groupsNum=1ï¼Œåˆ™å¯ä»¥å°†hart IDå¤ç”¨ä½œä¸ºAIAçš„`hartIndexï¼š</p>
<p>For a simple ungrouped system, set groupsNum=1 to allow reuse of hart ID as AIA's <code>hartIndex</code>:</p>
<pre><code class="language-scala">val imsic_params = IMSICParams(groupsNum=1, membersNum=4)
val aplic_params = APLICParams()
val imsics = (0 until 4).map( i =&gt; {
  val imsic = LazyModule(new TLIMSIC(imsic_params, i)(Parameters.empty))
val aplic = LazyModule(new TLAPLIC(aplic_params, imsic_params)(Parameters.empty))
</code></pre>
<h3 id="åˆ†ç»„çš„4æ ¸ç³»ç»Ÿa-grouped-4-hart-system"><a class="header" href="#åˆ†ç»„çš„4æ ¸ç³»ç»Ÿa-grouped-4-hart-system">åˆ†ç»„çš„4æ ¸ç³»ç»Ÿï¼ˆA Grouped 4-Hart Systemï¼‰</a></h3>
<p>ä¸ºäº†å•å…ƒæµ‹è¯•ï¼Œåœ¨<code>src/main/scala/ChiselAIA.scala</code>ä¸­ï¼Œæˆ‘ä»¬å®ä¾‹åŒ–äº†ä¸€ä¸ªæ¯ç»„2ä¸ªæˆå‘˜çš„2ç»„ç³»ç»Ÿï¼š</p>
<p>In <code>src/main/scala/ChiselAIA.scala</code>, for unit tests, we instantiate a 2-group 2-member-per-group system:</p>
<pre><code class="language-scala">val imsic_params = IMSICParams(groupsNum=2, membersNum=2)
val aplic_params = APLICParams()
val imsics = (0 until 4).map( i =&gt; {
  val imsic = LazyModule(new TLIMSIC(imsic_params, i)(Parameters.empty))
val aplic = LazyModule(new TLAPLIC(aplic_params, imsic_params)(Parameters.empty))
</code></pre>
<p>æ­¤é…ç½®åˆ›å»ºäº†ä¸€ä¸ª2ä½çš„<code>hartIndex</code>ï¼Œé«˜ä½è¡¨ç¤º groupIDï¼Œä½ä½è¡¨ç¤º memberIDã€‚
æœ‰å…³è¯¦ç»†çš„IOè¿æ¥ï¼Œè¯·å‚è€ƒ<code>src/main/scala/ChiselAIA.scala</code>ã€‚</p>
<p>This configuration creates a 2-bit <code>hartIndex</code> where the higher bit represents <code>groupID</code> and the lower bit represents <code>memberID</code>.
For detailed IO connections, refer to <code>src/main/scala/ChiselAIA.scala</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
